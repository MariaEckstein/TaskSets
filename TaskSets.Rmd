---
title: "TaskSets"
author: "Maria Eckstein"
date: "July 19, 2017"
output: html_document
---

```{r Set parameters, load packages, etc.}

library("ggplot2"); library("plyr")
theme_set(theme_bw())

n_aliens = 4

data_dir = "C:/Users/maria/MEGAsync/Berkeley/TaskSets/Data/17-09-13"
```
```{r Read in data}
filenames = list.files(data_dir, pattern = "*.csv")
all_files = data.frame()
for (filename in filenames) {
  subj_file = read.csv(file = file.path(data_dir, filename), header = T, na.strings = c("", "NA", "-1"))
  subj_file$subjID = strsplit(substr(as.character(subj_file$responses), 8, 10), "[^0-9]")[[1]][[1]]
  subj_file = subset(subj_file, select = -c(responses, internal_node_id, view_history))
  
  # Add trial column: counter within blocks
  subj_file$trial = NA
  for (row in 2:nrow(subj_file)) {
    if (is.na(subj_file$season[row])) {
      trial = NA
    } else {
      if (is.na(subj_file$season[row-1])) {
        trial = 1
      } else {
        trial = trial + 1
      }
    }
    subj_file$trial[row] = trial
  }
  
  # # Add block column
  # subj_file$block = NA
  # block = 0
  # for (row in 2:nrow(subj_file)) {
  #   if (!is.na(subj_file$trial[row])) {
  #     if (subj_file$trial[row] == 1) {
  #       block = block + 1
  #     }
  #   }
  #   subj_file$block[row] = block
  # }
  
  # Add alien-trial column
  subj_file$alien_trial = NA
  alien_season_counter = data.frame(training = rep(0, n_aliens),
                                    hot = rep(0, n_aliens), cold = rep(0, n_aliens), rainy = rep(0, n_aliens),
                                    hot_cloudy = rep(0, n_aliens), cold_cloudy = rep(0, n_aliens), rainy_cloudy = rep(0, n_aliens),
                                    rainbow = rep(0, n_aliens))
  for (row in 1:nrow(subj_file)) {
    sad_alien = subj_file$sad_alien[row] + 1
    if (!is.na(sad_alien)) {
      season = as.character(subj_file$season[row])
      alien_season_counter[sad_alien, season] = alien_season_counter[sad_alien, season] + 1
      subj_file$alien_trial[row] = alien_season_counter[sad_alien, season]
    }
  }
  
  all_files = rbind(all_files, subj_file)
}

all_files$subjID = as.numeric(as.character(all_files$subjID))
all_files$sad_alien = factor(all_files$sad_alien)
all_files$ACC = ifelse(all_files$correct == "true", 1, 0)

all_files$item_left = as.character(all_files$item_left)
all_files$item_right = as.character(all_files$item_right)
all_files$item_center = as.character(all_files$item_center)
for (row in 1:nrow(all_files)) {
  left_item = as.character(all_files$item_left[row])
  left_item_name = ifelse(is.na(left_item), NA, strsplit(strsplit(left_item, "id=\'")[[1]][2], "-button")[[1]])
  all_files$item_left[row] = left_item_name
  
  center_item = as.character(all_files$item_center[row])
  center_item_name = ifelse(is.na(center_item), NA, strsplit(strsplit(center_item, "id=\'")[[1]][2], "-button")[[1]])
  all_files$item_center[row] = center_item_name
  
  right_item = as.character(all_files$item_right[row])
  right_item_name = ifelse(is.na(right_item), NA, strsplit(strsplit(right_item, "id=\'")[[1]][2], "-button")[[1]])
  all_files$item_right[row] = right_item_name
}

all_files
summary(all_files)
```
```{r Clean data and create summary dataframe}

# all_files = subset(all_files, rt < 5000 & rt > 150)
# sum_data = ddply(all_files, .(subjID, trial_type, sad_alien, season), summarize,
#                  ACC = mean(correct, na.rm = T))
# summary(sum_data)

```
```{r Feed-alien phases}

# Get data frames for each phase (training, learning & refreshing, cloudy)
feed_aliens = subset(all_files, trial_type == "phase1")  #"feed-aliens")
training = subset(feed_aliens, season == "training")
learning = subset(feed_aliens, season %in% c("cold", "hot", "rainy"))
cloudy = subset(feed_aliens, season %in% paste(c("cold", "hot", "rainy"), "_cloudy", sep = ""))

# Plot learning curves (and RTs) for each phase
learning_curves = ggplot(training, aes(alien_trial, ACC)) +
  stat_summary(fun.data = mean_cl_normal, fun.args = list(mult = 1), geom = "point") +
  stat_summary(fun.data = mean_cl_normal, fun.args = list(mult = 1), geom = "line") +
  facet_grid(~ season)
learning_curves
learning_curves + facet_grid(sad_alien ~ season)  # Observation: Participants learn one alien after the other, rather than at the same time...

learning_curves$data = learning
learning_curves + aes(color = phase)
learning_curves + aes(color = phase) + facet_grid(sad_alien ~ season)
learning_curves + aes(alien_trial, rt, color = phase)
learning_curves + aes(alien_trial, rt, color = phase) + facet_grid(sad_alien ~ season)  # Observation: RTs are slowest when performance is worst

learning_curves$data = cloudy
learning_curves
learning_curves + facet_grid(sad_alien ~ season)
```
```{r Calculate empirical values for aliens, seasons, items}

# Calcuate "learnt values" (average reward for each alien/season/item obtained during the refresher right before picking)
learnt_values = subset(all_files, phase == "2b")  #"Refresher2"
alien_season_values = ddply(learnt_values, .(subjID, sad_alien, season), summarize,
                            av_reward = mean(reward, na.rm = T))
alien_season_values$pickee = with(alien_season_values, paste("alien", as.numeric(as.character(sad_alien)) + 1, season, sep = ""))
alien_season_values$assess = "alien-same-season"
alien_season_values$sad_alien = alien_season_values$season = NULL

alien_values = ddply(learnt_values, .(subjID, sad_alien), summarize,
                     av_reward = mean(reward, na.rm = T))
alien_values$pickee = with(alien_values, paste("alien", as.numeric(as.character(sad_alien)) + 1, sep = ""))
alien_values$assess = "alien"
alien_values$sad_alien = NULL

season_values = ddply(learnt_values, .(subjID, season), summarize,
                      av_reward = mean(reward, na.rm = T))
season_values$pickee = season_values$season
season_values$assess = "season"
season_values$season = NULL

item_values = ddply(learnt_values, .(subjID, item_chosen), summarize,
                    av_reward = mean(reward, na.rm = T))
item_values$pickee = item_values$item_chosen
item_values$assess = "item"
item_values$item_chosen = NULL

all_values = rbind(alien_season_values, alien_values, season_values, item_values)

ggplot(all_values, aes(assess, av_reward, color = pickee)) +
  geom_bar(stat = "identity", position = "dodge") +
  coord_flip()
```
```{r Phase 3: Pick aliens, seasons, items}
# Add learnt values to all_files
pick_aliens = subset(all_files, trial_type == "phase2")  #"pick-aliens"
pick_aliens$item_chosen = as.character(pick_aliens$item_chosen)
for (row in 1:nrow(pick_aliens)) {
  chosen_item = as.character(pick_aliens$item_chosen[row])
  chosen_item_name = ifelse(is.na(chosen_item), NA, strsplit(strsplit(chosen_item, "#")[[1]][2], "-button")[[1]])
  pick_aliens$item_chosen[row] = chosen_item_name
}

for (which in c("left", "right", "chosen")) {
  pick_aliens = merge(pick_aliens, all.x = T,
                  subset(all_values, select = c("subjID", "pickee", "av_reward")),
                  by.x = c("subjID", paste("item_", which, sep = "")), by.y = c("subjID", "pickee"))
  colnames(pick_aliens)[colnames(pick_aliens) == "av_reward"] = paste("value_", which, sep = "")
}
pick_aliens$value_unchosen = with(pick_aliens, ifelse(item_chosen == item_left, value_right, value_left))
pick_aliens$value_diff = with(pick_aliens, value_chosen - value_unchosen)

ggplot(pick_aliens, aes(trial_index, value_diff, color = assess)) +
  geom_point()

```
