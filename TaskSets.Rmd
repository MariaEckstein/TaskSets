---
title: "TaskSets"
author: "Maria Eckstein"
date: "July 19, 2017"
output: html_document
---

```{r Set parameters, load packages, etc.}

# TDs:
# CHECK sort cloudy learning curves by the value of the TS-alien (average over 3 or so), rather than by TS ~ alien
# CHECK check if participants learn the whole TS, or if they learn TS-alien values separately: run a logistic regression alien0_acc_t ~ alien0_acc_tminus1 + alien123_acc_tminus1 (+ TS)
# discriminate rainbow strategies: 0 variance (all the same choice); variance 1 (pick a different one each time); closest to TS0 / TS1 / TS2
# plot reward distributions for each TS (question: do they overlap more for the slower-learned, harder, lower-value TS?)
# problems with current paradigm:
  # 1) competition phase: according to what do they make selections?! -> check if it's memory (TS-alien performance during learning block beforehand); cuteness (are some aliens / TS / items preferred over others?)
  # 2) learning speed: TS0 is learned faster than TS1, than TS2 -> this confounds inference in the cloudy season; and everything else too -> make incorrect-feedback totally informative, i.e., 0?

library("ggplot2"); library("plyr"); library("lme4")
theme_set(theme_bw())

n_aliens = 4
data_dir = "C:/Users/maria/MEGAsync/Berkeley/TaskSets/Data/17-11-29"
plot_dir = file.path(data_dir, "plots")
if (!dir.exists(plot_dir)) {
  dir.create(plot_dir)
}
perf_criterion = 0.5  # participants who perform worse that that at the end of training (last 4 trials per alien) are excluded
gg_save = T
run_regression = F
```
```{r Read in data}
filenames = list.files(data_dir, pattern = "*.csv")
all_files = data.frame()
for (filename in filenames) {
  subj_file = read.csv(file = file.path(data_dir, filename), header = T, na.strings = c("", "NA", "-1"))
  subj_file$subjID = strsplit(substr(as.character(subj_file$responses), 8, 10), "[^0-9]")[[1]][[1]]
  subj_file = subset(subj_file, select = -c(responses, internal_node_id, view_history))
  
  # Add trial column: counter within blocks
  subj_file$trial = NA
  for (row in 2:nrow(subj_file)) {
    if (is.na(subj_file$season[row])) {
      trial = NA
    } else {
      if (is.na(subj_file$season[row-1])) {
        trial = 1
      } else {
        trial = trial + 1
      }
    }
    subj_file$trial[row] = trial
  }
  
  # Add alien-trial column and repetition column (TD: count repetitions over TS, rather than seasons (keep counting through cloudy season); add repetition (how often has subject seen this TS?))
  subj_file$alien_trial = NA
  alien_season_counter = data.frame(training = rep(0, n_aliens),
                                    hot = rep(0, n_aliens), cold = rep(0, n_aliens), rainy = rep(0, n_aliens),
                                    hot_cloudy = rep(0, n_aliens), cold_cloudy = rep(0, n_aliens), rainy_cloudy = rep(0, n_aliens),
                                    rainbow = rep(0, n_aliens))
  # subj_file$repetition = NA
  # reps = data.frame(TS = c(0:2, "training"), rep = 0)
  
  for (row in 1:nrow(subj_file)) {
    sad_alien = subj_file$sad_alien[row] + 1
    if (!is.na(sad_alien)) {
      season = as.character(subj_file$season[row])
      alien_season_counter[sad_alien, season] = alien_season_counter[sad_alien, season] + 1
      count = alien_season_counter[sad_alien, season]
      subj_file$alien_trial[row] = count
      # if (count == 1) {
      #   current_TS = subj_file$TS[row]
      #   TS_count = subset(reps, TS == current_TS)$rep
      #   subj_file$repetition[row] = TS_count
      # }
    }
  }
  
  all_files = rbind(all_files, subj_file)
}

all_files$subjID = as.numeric(as.character(all_files$subjID))
all_files$sad_alien = factor(all_files$sad_alien)
all_files$ACC = ifelse(all_files$correct == "true", 1, 0)

all_files$item_left = as.character(all_files$item_left)
all_files$item_right = as.character(all_files$item_right)
all_files$item_center = as.character(all_files$item_center)
for (row in 1:nrow(all_files)) {
  left_item = as.character(all_files$item_left[row])
  left_item_name = ifelse(is.na(left_item), NA, strsplit(strsplit(left_item, "id=\'")[[1]][2], "-button")[[1]])
  all_files$item_left[row] = left_item_name
  
  center_item = as.character(all_files$item_center[row])
  center_item_name = ifelse(is.na(center_item), NA, strsplit(strsplit(center_item, "id=\'")[[1]][2], "-button")[[1]])
  all_files$item_center[row] = center_item_name
  
  right_item = as.character(all_files$item_right[row])
  right_item_name = ifelse(is.na(right_item), NA, strsplit(strsplit(right_item, "id=\'")[[1]][2], "-button")[[1]])
  all_files$item_right[row] = right_item_name
}

all_files$time_elapsed = all_files$points0 = all_files$points1 = all_files$points2 = NULL
all_files$TS = as.character(all_files$TS)
all_files$TS[is.na(all_files$TS)] = as.character(all_files$season[is.na(all_files$TS)])  # if column TS is NA, replace it with season column
all_files$TS = factor(all_files$TS)

all_files
summary(all_files)
```
```{r Clean data and create summary dataframe}

# all_files = subset(all_files, rt < 5000 & rt > 150)
# sum_data = ddply(all_files, .(subjID, trial_type, sad_alien, season), summarize,
#                  ACC = mean(correct, na.rm = T))
# summary(sum_data)

# Exclude subjects who don't reach criterion in training block
criterion_dat = subset(all_files, season == "training" & alien_trial %in% 8:10)
perf_dat = ddply(criterion_dat, .(subjID), summarize,
                 ACC = mean(ACC, na.rm = T))
perf_dat$below_criterion = perf_dat$ACC < perf_criterion
(chance_performers = subset(perf_dat, below_criterion == T))
all_files = subset(all_files, !subjID %in% chance_performers$subjID)
```
```{r Calculate empirical values for aliens, seasons, items}

# Calcuate "learnt values" (average reward for each alien/TS/item obtained during the refresher right before picking)
learnt_values = subset(all_files, phase == "Refresher2" & item_chosen != "NaN")
alien_values = ddply(learnt_values, .(subjID, sad_alien), summarize,
                     av_reward = mean(reward, na.rm = T))
alien_values$selected = with(alien_values, paste("alien", as.numeric(as.character(sad_alien)) + 1, sep = ""))
alien_values$assess = "Alien"
alien_values$sad_alien = NULL

TS_values = ddply(learnt_values, .(subjID, TS), summarize,
                      av_reward = mean(reward, na.rm = T))
TS_values$selected = paste("TS", TS_values$TS, sep = "")
TS_values$assess = "TS"
TS_values$TS = NULL

item_values = ddply(learnt_values, .(subjID, item_chosen), summarize,
                    av_reward = mean(reward, na.rm = T))
item_values$selected = item_values$item_chosen
item_values$assess = "Item"
item_values$item_chosen = NULL

all_values = rbind(alien_values, TS_values, item_values)
all_values

value_plot = ggplot(all_values, aes(assess, av_reward, fill = selected)) +
  stat_summary(fun.data = "mean_cl_normal", geom = "bar", position = "dodge") +
  stat_summary(fun.data = "mean_cl_normal", geom = "pointrange", position = position_dodge(width = 0.9)) +
  labs(y = "Average reward / trial", x = "", fill = "") +
  coord_flip()
value_plot_subj = value_plot + facet_wrap(~ paste("Subj", subjID))

# Values for alien-TS combinations
alien_TS_values = ddply(learnt_values, .(subjID, TS, sad_alien), summarize,
                        av_reward = mean(reward, na.rm = T))
alien_TS_values$selected = with(alien_TS_values, paste("alien", as.numeric(as.character(sad_alien))+1, TS, sep = ""))
alien_TS_values$assess = "AlienSameTS"

alien_plot = value_plot + aes(x = TS, fill = sad_alien) + labs(x = "TS", fill = "Alien")
alien_plot$data = alien_TS_values
alien_plot2 = alien_plot + facet_wrap(~ paste("Subj", subjID))

alien_TS_obj = expand.grid(sad_alien = unique(alien_TS_values$sad_alien),
                           TS = unique(alien_TS_values$TS),
                           assess = "alien-same-TS")
alien_TS_obj$av_reward = c(6, 4, 5, 10,
                           2, 8, 7, 3,
                           7, 3, 3, 2)
alien_TS_obj$selected = alien_TS_obj$sad_alien
alien_TS_obj$assess = alien_TS_obj$TS

alien_TS_obj

true_values = value_plot + labs(title = "True underlying TS", fill = "Alien")
true_values$data = alien_TS_obj

if (gg_save) {
  ggsave(file.path(plot_dir, "2value_plot.png"), value_plot, width = 3, height = 3)
  ggsave(file.path(plot_dir, "2value_plot_subj.png"), value_plot_subj, width = 15, height = 15)
  ggsave(file.path(plot_dir, "2alien_plot.png"), alien_plot, width = 3, height = 3)
  ggsave(file.path(plot_dir, "2alien_plot2.png"), alien_plot2, width = 15, height = 15)
  ggsave(file.path(plot_dir, "2true_values.png"), true_values, width = 3, height = 3)
}
```
```{r Feed-alien phases}

# TD: run the same analyses on the learning phase as on the cloudy phase: influence of value / reward and acc_1back_self & acc_1back_other on learning; change in that over time; etc.

# Get data frames for each phase (training, learning & refreshing, cloudy)
(feed_aliens = subset(all_files, trial_type == "feed-aliens"))
feed_aliens = merge(feed_aliens, all.x = T,  # add av_reward column
                    subset(alien_TS_obj, select = c("sad_alien", "TS", "av_reward")),
                    by = c("sad_alien", "TS"))
# (training = subset(feed_aliens, phase == "Training"))
# (learning = subset(feed_aliens, phase == "Learning"))
# (rainbow = subset(feed_aliens, phase == "Rainbow"))
# (cloudy = subset(feed_aliens, phase == "Cloudy"))

# Plot learning curves (and RTs) for each phase
basic_learning_curves = ggplot(feed_aliens, aes(trial_index, 100 * ACC, color = phase)) +
  stat_summary(fun.data = mean_se, geom = "pointrange") +
  geom_hline(yintercept = 100/3, linetype = "dotted") +
  labs(x = "Trial", y = "% correct")
training_curves = ggplot(training, aes(alien_trial, 100 * ACC)) +
  stat_summary(fun.data = mean_se, geom = "pointrange") +
  labs(x = "Trial", y = "% correct") +
  coord_cartesian(y = c(0, 100))

training_curves2 = training_curves + facet_wrap( ~ paste("Subj", subjID))
training_curves3 = training_curves + facet_grid(paste("Subj", subjID) ~ paste("Alien", sad_alien))

learning_curves = training_curves + aes(color = phase)
learning_curves$data = learning
learning_curves_TS = learning_curves + facet_grid(~ paste("Task set", TS))
learning_curves_TS_aliens = learning_curves + facet_grid(paste("Alien", sad_alien) ~ paste("Task set", TS))
RT_curves = learning_curves + aes(alien_trial, rt, color = phase) + coord_cartesian(y = c(400, 900)) + labs(y = "Response time (ms)")
RT_TS_curves = learning_curves + aes(alien_trial, rt, color = phase) + coord_cartesian(y = c(400, 900)) + labs(x = "Trial", y = "Response time (ms)") + facet_grid(~ paste("Task set", TS))

# cloudy_curves => see next block!

if (gg_save) {
  ggsave(file.path(plot_dir, "1training_curves.png"), training_curves, width = 3, height = 3)
  ggsave(file.path(plot_dir, "1training_curves2.png"), training_curves2, width = 15, height = 10)
  ggsave(file.path(plot_dir, "1training_curves3.png"), training_curves3, width = 3, height = 20)
  ggsave(file.path(plot_dir, "1learning_curves.png"), learning_curves, width = 7, height = 3)
  ggsave(file.path(plot_dir, "1learning_curves_TS.png"), learning_curves_TS, width = 14, height = 3)
  ggsave(file.path(plot_dir, "1learning_curves_TS_aliens.png"), learning_curves_TS_aliens, width = 15, height = 15)
  ggsave(file.path(plot_dir, "1RT_curves.png"), RT_curves, width = 7, height = 3)
  ggsave(file.path(plot_dir, "1RT_TS_curves.png"), RT_TS_curves, width = 9, height = 3)
}
```
```{r Cloudy season: Do participants infer whole TS or individual items}
# 
# cloudy = subset(feed_aliens, season %in% paste(c("cold", "hot", "rainy"), "_cloudy", sep = ""))
# 
# cloudy_curves1 = ggplot(cloudy, aes(trial_index, 100 * ACC)) +
#   stat_summary(fun.data = mean_se, geom = "pointrange") +
#   geom_hline(yintercept = 100/3, linetype = "dotted") +
#   labs(x = "Trial", y = "% correct")
# 
# cloudy = merge(cloudy,
#                subset(alien_TS_obj, select = c("sad_alien", "TS", "av_reward")),
#                by = c("sad_alien", "TS"))
cloudy$alien_trial[cloudy$alien_trial > 10] = cloudy$alien_trial[cloudy$alien_trial > 10] - 10
cloudy = cloudy[order(cloudy$subjID, cloudy$sad_alien, cloudy$TS, cloudy$alien_trial),]  # bring in the right order for regression: each line must be the predictor of the immediate next line!

cloudy_curves = learning_curves + aes(color = TS, shape = sad_alien) + labs(title = "Cloudy phase - separated by av. rewards") + facet_grid( ~ av_reward)
cloudy_curves2 = training_curves + aes(color = av_reward, group = av_reward) + stat_summary(fun.data = mean_se, geom = "line") + labs(color = "Value")
cloudy_curves$data = cloudy_curves2$data = cloudy

dat = subset(cloudy, select = c("subjID", "sad_alien", "TS", "av_reward", "alien_trial", "ACC"))

ACC_1back_self = c(NA, dat$ACC[1:length(dat$ACC)-1])
ACC_1back_self[dat$alien_trial == 1] = NA
dat$ACC_1back_self = ACC_1back_self

others_dat = data.frame()
for (alien in unique(dat$sad_alien)) {
  alien_dat = ddply(subset(dat, sad_alien != alien),
        .(subjID, TS, alien_trial), summarize,
        ACC_others = mean(ACC, na.rm = T))
  alien_dat$sad_alien = alien
  others_dat = rbind(others_dat, alien_dat)
}
ACC_1back_others = c(NA, others_dat$ACC_others[1:length(others_dat$ACC_others)-1])
ACC_1back_others[others_dat$alien_trial == 1] = NA
others_dat$ACC_1back_others = ACC_1back_others

dat = merge(others_dat, dat,  # sanity check: dat should have 12000 rows: 50 subj * 20 alien_trials * 3 TS * 4 sad_aliens
            by = c("subjID", "TS", "sad_alien", "alien_trial"))
dat$TS = factor(dat$TS)
dat$sad_alien = factor(dat$sad_alien)

regression_plot = alien_plot + aes(TS, 100 * ACC, fill = sad_alien) + labs(y = "% correct", fill = "Alien")
regression_plot$data = dat

if (run_regression) {
  
  glmer_mod_1back_self_others = glmer(ACC ~ ACC_1back_self * ACC_1back_others + (ACC_1back_self * ACC_1back_others | subjID),
                    family = binomial,
                    data = dat,
                    na.action = na.omit,
                    control = glmerControl(optimizer = 'bobyqa', optCtrl = list(maxfun = 1e6)))
  write.csv(as.data.frame(summary(glmer_mod_1back_self_others)$coef), file.path(plot_dir, "glmer_1back_selfothers_summary.csv"))
  write.csv(as.data.frame(anova(glmer_mod_1back_self_others, type = 3)), file.path(plot_dir, "glmer_1back_selfothers_aov.csv"))
  
  glmer_mod_value = glmer(ACC ~ av_reward + (av_reward | subjID),
                    family = binomial,
                    data = dat,
                    na.action = na.omit,
                    control = glmerControl(optimizer = 'bobyqa', optCtrl = list(maxfun = 1e6)))
  write.csv(as.data.frame(summary(glmer_mod_value)$coef), file.path(plot_dir, "glmer_value_summary.csv"))
  write.csv(as.data.frame(anova(glmer_mod_value, type = 3)), file.path(plot_dir, "glmer_value_aov.csv"))

  glmer_mod_all3 = glmer(ACC ~ ACC_1back_self * ACC_1back_others * av_reward + (ACC_1back_self * ACC_1back_others * av_reward | subjID),
                    family = binomial,
                    data = dat,
                    na.action = na.omit,
                    control = glmerControl(optimizer = 'bobyqa', optCtrl = list(maxfun = 1e7)))
  summary(glmer_mod_all3)
  write.csv(as.data.frame(summary(glmer_mod_all3)$coef), file.path(plot_dir, "glmer_all3_summary.csv"))
  write.csv(as.data.frame(anova(glmer_mod_all3, type = 3)), file.path(plot_dir, "glmer_all3_aov.csv"))
  }

if (gg_save) {
  ggsave(file.path(plot_dir, "1cloudy_curves.png"), cloudy_curves, width = 15, height = 3)
  ggsave(file.path(plot_dir, "1cloudy_curves1.png"), cloudy_curves1, width = 15, height = 3)
  ggsave(file.path(plot_dir, "1cloudy_curves2.png"), cloudy_curves2, width = 4, height = 3)
  ggsave(file.path(plot_dir, "3regression_plot.png"), regression_plot, width = 3, height = 3)
}
```
```{r Phase 3: Pick aliens, TSs, items}

# all_values: what are the experiences values of each alien, item, TS, and each alien-TS combo?
all_values = rbind(subset(alien_TS_values, select = c("subjID", "assess", "selected", "av_reward")),
                    subset(alien_values, select = c("subjID", "assess", "selected", "av_reward")),
                    subset(TS_values, select = c("subjID", "assess", "selected", "av_reward")),
                    subset(item_values, select = c("subjID", "assess", "selected", "av_reward")))

# pick_aliens: Which choices did subjects make in phase 3?
pick_aliens = subset(all_files, trial_type == "pick-aliens", select = c("subjID", "trial_index", "item_left", "item_right", "item_chosen", "assess"))

# season_TS: which season for each subject corresponded to each TS?
season_TS = ddply(subset(all_files, trial_type == "feed-aliens" & season %in% c("hot", "rainy", "cold")),
                  .(subjID, TS, season), summarize,
                  TS = TS[1])

## Adjust pick_aliens
### Remove "-button"
pick_aliens$item_chosen = as.character(pick_aliens$item_chosen)
for (row in 1:nrow(pick_aliens)) {
  chosen_item = as.character(pick_aliens$item_chosen[row])
  chosen_item_name = ifelse(is.na(chosen_item), NA, strsplit(strsplit(chosen_item, "#")[[1]][2], "-button")[[1]])
  pick_aliens$item_chosen[row] = chosen_item_name
}
### Replace "hot", "cold", "rainy" with participants' corresponding TS 
for (subj in levels(factor(all_files$subjID))) {
  for (seas in c("hot", "cold", "rainy")) {
    sub = subset(season_TS, subjID == subj & season == seas)$TS
    pick_aliens$item_right = gsub(seas, sub, pick_aliens$item_right)
    pick_aliens$item_left = gsub(seas, sub, pick_aliens$item_left)
    pick_aliens$item_chosen = gsub(seas, sub, pick_aliens$item_chosen)
  }
}
pick_aliens$assess = as.character(pick_aliens$assess)
pick_aliens$assess = gsub("season", "TS", pick_aliens$assess)
pick_aliens$item_unchosen = ifelse(pick_aliens$item_chosen == pick_aliens$item_right, pick_aliens$item_left, pick_aliens$item_right)
pick_aliens$item_left = pick_aliens$item_right = NULL
### Rename "0", "1", "2" to "TS0", "TS1", "TS2"
pick_aliens$item_chosen = as.character(pick_aliens$item_chosen)
pick_aliens$item_chosen[pick_aliens$assess == "TS"] = paste("TS", pick_aliens$item_chosen[pick_aliens$assess == "TS"], sep = "")
pick_aliens$item_unchosen = as.character(pick_aliens$item_unchosen)
pick_aliens$item_unchosen[pick_aliens$assess == "TS"] = paste("TS", pick_aliens$item_unchosen[pick_aliens$assess == "TS"], sep = "")
### Add columns for the values of each trial's chosen and unchosen items
for (col in c("unchosen", "chosen")) {
  pick_aliens = merge(pick_aliens, all.x = T,
                      subset(all_values, select = c("subjID", "selected", "av_reward")),
                      by.x = c("subjID", paste("item_", col, sep = "")), by.y = c("subjID", "selected"))
  colnames(pick_aliens)[colnames(pick_aliens) == "av_reward"] = paste("value_", col, sep = "")
}

pick_aliens_sum = ddply(subset(pick_aliens, !is.na(assess)), .(subjID, assess), summarize,
                        value_diff = mean(value_chosen - value_unchosen, na.rm = T))

gg_pick_aliens = ggplot(pick_aliens_sum, aes(assess, value_diff, color = subjID)) +
  stat_summary(fun.y = "mean", geom = "bar") +
  stat_summary(fun.data = "mean_se", geom = "pointrange") +
  labs(x = "Trial", y = "Value chosen minus unchosen", color = "Participant ID") +
  geom_point(position = "jitter", alpha = 0.3)

gg_pick_aliens_subj = ggplot(subset(pick_aliens), aes(trial_index, value_chosen - value_unchosen, color = assess)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  labs(x = "Trial", y = "Value chosen minus unchosen", color = "") +
  facet_wrap(~ subjID)

if (gg_save) {
  ggsave(file.path(plot_dir, "3gg_pick_aliens.png"), gg_pick_aliens, width = 5, height = 3)
  ggsave(file.path(plot_dir, "3gg_pick_aliens_subj.png"), gg_pick_aliens_subj, width = 15, height = 15)
}
```
```{r Rainbow season}

correct_values = ddply(subset(all_files, ACC == 1 & season %in% c("cold", "hot", "rainy")),
                      .(subjID, TS, sad_alien), summarize,
                      av_reward = mean(reward, na.rm = T),
                      item_chosen = item_chosen[1])
correct_values  # agrees with the TS!

rainbow_aliens = ddply(subset(rainbow, item_chosen != "NaN"),
                       c("subjID", "sad_alien", "TS", "item_chosen"),
                       summarize,
                       av_reward = 2 * sum(!is.na(item_chosen)))  # add column that indicates in how many trials subject chose each item for each alien

# Combine OPTIMAL CHOICES (not necessarily subject's choices) with subject's choices in the rainbow season
comb_dat = merge(correct_values,
                 rainbow_aliens,
                 by = c("subjID", "sad_alien", "TS", "item_chosen", "av_reward"), all = T)
comb_dat

# Plot OPTIMAL CHOICES in every season together with subject's choices in the rainbow season
comb_dat_sum = ddply(comb_dat, .(sad_alien, item_chosen, TS), summarize,
                      av_reward = mean(av_reward, na.rm = T))
comb_dat_sum$av_reward[comb_dat_sum$TS == "rainbow"] = 7 * comb_dat_sum$av_reward[comb_dat_sum$TS == "rainbow"] - 15  # to make differences in size more evident

gg_rainbow_choice = ggplot(comb_dat_sum, aes(sad_alien, item_chosen, color = TS, size = av_reward)) +
  geom_point() +
  theme(legend.position = "none") +
  labs(x = "Alien ID", y = "", color = "") +
  facet_grid( ~ paste("TS", TS))

gg_rainbow_choice_subj = ggplot(subset(comb_dat, TS == "rainbow"), aes(sad_alien, item_chosen, color = TS, size = av_reward)) +
  geom_point() +
  theme(legend.position = "none") +
  facet_wrap(~ paste("Subj", subjID))

# Categorize participants' strategies
rainbow_aliens$strategy = "TS-strategy"
for (subj in unique(rainbow_aliens$subjID)) {
  subj_dat = subset(rainbow_aliens, subjID == subj)
  if (all(subj_dat$av_reward == subj_dat$av_reward[1])) {  # if all items have been chosen equally often for all items
    rainbow_aliens$strategy[rainbow_aliens$subjID == subj] = "Variance 0/1"
  } #else if ()
}
# for (item in unique(rainbow_aliens$item_chosen)) {
#   for (subj in unique(rainbow_aliens$subjID)) {
#     row = subset(rainbow_aliens, item_chosen == item & subjID == subj)
#     if (nrow(row)== 4) {  # if participant 
#       while (all(row$av_reward == row$av_reward[1]) & row$av_reward[1] > 0) {
#         rainbow_aliens[rainbow_aliens$item_chosen == item & rainbow_aliens$subjID == subj, "av_reward"] = rainbow_aliens[rainbow_aliens$item_chosen == item & rainbow_aliens$subjID == subj, "av_reward"] - 1
#         row = subset(rainbow_aliens, item_chosen == item & subjID == subj)
#       }
#     }
#   }
# }

# rainbow_aliens$av_reward[rainbow_aliens$av_reward <= 2] = NA
# comb_dat2 = merge(correct_values,
#                  rainbow_aliens,
#                  by = c("subjID", "sad_alien", "TS", "item_chosen", "av_reward"), all = T)
# comb_dat_sum2 = ddply(comb_dat2, .(sad_alien, item_chosen, TS), summarize,
#                       av_reward = sum(av_reward, na.rm = T))
# comb_dat_sum2$av_reward[comb_dat_sum2$TS == "rainbow"] = 5 * comb_dat_sum2$av_reward[comb_dat_sum2$TS == "rainbow"] - 9
# 
# gg_rainbow_choice2 = ggplot(comb_dat_sum2, aes(sad_alien, item_chosen, color = TS, size = av_reward)) +
#   geom_point() +
#   theme(legend.position = "none") +
#   labs(x = "Alien ID", y = "", color = "") +
#   facet_grid( ~ paste("TS", TS))
# gg_rainbow_choice2

gg_rainbow_choice_subj2 = ggplot(subset(rainbow_aliens, strategy != "Variance 0/1"), aes(sad_alien, item_chosen, color = TS, size = av_reward)) +
  geom_point() +
  theme(legend.position = "none") +
  facet_wrap(~ paste("Subj", subjID))
gg_rainbow_choice_subj2

if (gg_save) {
  ggsave(file.path(plot_dir, "4gg_rainbow_choice.png"), gg_rainbow_choice, width = 5, height = 3)
  ggsave(file.path(plot_dir, "4gg_rainbow_choice_subj.png"), gg_rainbow_choice_subj, width = 15, height = 15)
}
```
```{r Start button}
```