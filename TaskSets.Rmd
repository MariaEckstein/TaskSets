---
title: "TaskSets"
author: "Maria Eckstein"
date: "July 19, 2017"
output: html_document
---

```{r Set parameters, load packages, etc.}
library("ggplot2"); library("plyr")
theme_set(theme_bw())

n_aliens = 4
data_dir = "C:/Users/maria/MEGAsync/Berkeley/TaskSets/Data/17-10-16"
perf_criterion = 0.5  # participants who perform worse that that at the end of training (last 4 trials per alien) are excluded
```
```{r Read in data}
filenames = list.files(data_dir, pattern = "*.csv")
all_files = data.frame()
for (filename in filenames) {
  subj_file = read.csv(file = file.path(data_dir, filename), header = T, na.strings = c("", "NA", "-1"))
  subj_file$subjID = strsplit(substr(as.character(subj_file$responses), 8, 10), "[^0-9]")[[1]][[1]]
  subj_file = subset(subj_file, select = -c(responses, internal_node_id, view_history))
  
  # Add trial column: counter within blocks
  subj_file$trial = NA
  for (row in 2:nrow(subj_file)) {
    if (is.na(subj_file$season[row])) {
      trial = NA
    } else {
      if (is.na(subj_file$season[row-1])) {
        trial = 1
      } else {
        trial = trial + 1
      }
    }
    subj_file$trial[row] = trial
  }
  
  # Add alien-trial column and repetition column (TD: count repetitions over TS, rather than seasons (keep counting through cloudy season); add repetition (how often has subject seen this TS?))
  subj_file$alien_trial = NA
  alien_season_counter = data.frame(training = rep(0, n_aliens),
                                    hot = rep(0, n_aliens), cold = rep(0, n_aliens), rainy = rep(0, n_aliens),
                                    hot_cloudy = rep(0, n_aliens), cold_cloudy = rep(0, n_aliens), rainy_cloudy = rep(0, n_aliens),
                                    rainbow = rep(0, n_aliens))
  # subj_file$repetition = NA
  # reps = data.frame(TS = c(0:2, "training"), rep = 0)
  
  for (row in 1:nrow(subj_file)) {
    sad_alien = subj_file$sad_alien[row] + 1
    if (!is.na(sad_alien)) {
      season = as.character(subj_file$season[row])
      alien_season_counter[sad_alien, season] = alien_season_counter[sad_alien, season] + 1
      count = alien_season_counter[sad_alien, season]
      subj_file$alien_trial[row] = count
      # if (count == 1) {
      #   current_TS = subj_file$TS[row]
      #   TS_count = subset(reps, TS == current_TS)$rep
      #   subj_file$repetition[row] = TS_count
      # }
    }
  }
  
  all_files = rbind(all_files, subj_file)
}

all_files$subjID = as.numeric(as.character(all_files$subjID))
all_files$sad_alien = factor(all_files$sad_alien)
all_files$ACC = ifelse(all_files$correct == "true", 1, 0)

all_files$item_left = as.character(all_files$item_left)
all_files$item_right = as.character(all_files$item_right)
all_files$item_center = as.character(all_files$item_center)
for (row in 1:nrow(all_files)) {
  left_item = as.character(all_files$item_left[row])
  left_item_name = ifelse(is.na(left_item), NA, strsplit(strsplit(left_item, "id=\'")[[1]][2], "-button")[[1]])
  all_files$item_left[row] = left_item_name
  
  center_item = as.character(all_files$item_center[row])
  center_item_name = ifelse(is.na(center_item), NA, strsplit(strsplit(center_item, "id=\'")[[1]][2], "-button")[[1]])
  all_files$item_center[row] = center_item_name
  
  right_item = as.character(all_files$item_right[row])
  right_item_name = ifelse(is.na(right_item), NA, strsplit(strsplit(right_item, "id=\'")[[1]][2], "-button")[[1]])
  all_files$item_right[row] = right_item_name
}

all_files$time_elapsed = all_files$points0 = all_files$points1 = all_files$points2 = NULL
all_files$TS = as.character(all_files$TS)
all_files$TS[is.na(all_files$TS)] = as.character(all_files$season[is.na(all_files$TS)])  # if column TS is NA, replace it with season column
all_files$TS = factor(all_files$TS)

all_files
summary(all_files)
```
```{r Clean data and create summary dataframe}

# all_files = subset(all_files, rt < 5000 & rt > 150)
# sum_data = ddply(all_files, .(subjID, trial_type, sad_alien, season), summarize,
#                  ACC = mean(correct, na.rm = T))
# summary(sum_data)

# Exclude subjects who don't reach criterion in training block
criterion_dat = subset(all_files, season == "training" & alien_trial %in% 8:10)
perf_dat = ddply(criterion_dat, .(subjID), summarize,
                 ACC = mean(ACC, na.rm = T))
perf_dat$below_criterion = perf_dat$ACC < perf_criterion
(chance_performers = subset(perf_dat, below_criterion == T))
all_files = subset(all_files, !subjID %in% chance_performers$subjID)
```
```{r Feed-alien phases}

# Get data frames for each phase (training, learning & refreshing, cloudy)
(feed_aliens = subset(all_files, trial_type == "feed-aliens"))  #"phase1")
(training = subset(feed_aliens, season == "training"))
(learning = subset(feed_aliens, season %in% c("cold", "hot", "rainy")))
(cloudy = subset(feed_aliens, season %in% paste(c("cold", "hot", "rainy"), "_cloudy", sep = "")))
(rainbow = subset(feed_aliens, season == "rainbow"))

# Plot learning curves (and RTs) for each phase (TD: different shapes for different repetitions? Brake line between repetitions (block of 10 trials)?)
learning_curves = ggplot(training, aes(alien_trial, ACC)) +  # group = repetition
  stat_summary(fun.data = mean_cl_normal, fun.args = list(mult = 1), geom = "pointrange") +
  stat_summary(fun.data = mean_cl_normal, fun.args = list(mult = 1), geom = "line") +
  coord_cartesian(y = c(0, 1))
learning_curves + facet_grid(paste("Subj", subjID) ~ .)
learning_curves + facet_grid(paste("Subj", subjID) ~ paste("Alien", sad_alien))  # Observation: Participants learn one alien after the other, rather than at the same time...

learning_curves$data = learning
learning_curves + aes(color = phase)
learning_curves + aes(color = phase) + facet_grid(paste("Subj", subjID) ~ paste("Task set", TS))
learning_curves + aes(color = phase) + facet_grid(~ paste("Task set", TS))
learning_curves + aes(alien_trial, rt, color = phase)
learning_curves + aes(alien_trial, rt, color = phase) + facet_grid(paste("Alien", sad_alien) ~ paste("Task set", TS))  # Observation: RTs are slowest when performance is worst

learning_curves$data = cloudy
learning_curves
learning_curves + facet_grid(paste("Alien", sad_alien) ~ paste("Task set", TS))
```
```{r Calculate empirical values for aliens, seasons, items}

# Calcuate "learnt values" (average reward for each alien/TS/item obtained during the refresher right before picking)
learnt_values = subset(all_files, phase == "Refresher2" & item_chosen != "NaN")
alien_values = ddply(learnt_values, .(subjID, sad_alien), summarize,
                     av_reward = mean(reward, na.rm = T))
alien_values$selected = with(alien_values, paste("alien", as.numeric(as.character(sad_alien)) + 1, sep = ""))
alien_values$assess = "Alien"
alien_values$sad_alien = NULL

TS_values = ddply(learnt_values, .(subjID, TS), summarize,
                      av_reward = mean(reward, na.rm = T))
TS_values$selected = paste("TS", TS_values$TS, sep = "")
TS_values$assess = "TS"
TS_values$TS = NULL

item_values = ddply(learnt_values, .(subjID, item_chosen), summarize,
                    av_reward = mean(reward, na.rm = T))
item_values$selected = item_values$item_chosen
item_values$assess = "Item"
item_values$item_chosen = NULL

all_values = rbind(alien_values, TS_values, item_values)
all_values

value_plot = ggplot(all_values, aes(assess, av_reward, fill = selected)) +
  geom_bar(stat = "identity", position = "dodge") +
  coord_flip()
value_plot + facet_wrap(~ paste("Subj", subjID))

# Values for alien-TS combinations
alien_TS_values = ddply(learnt_values, .(subjID, TS, sad_alien), summarize,
                        av_reward = mean(reward, na.rm = T))
alien_TS_values$selected = alien_TS_values$sad_alien
alien_TS_values$assess = alien_TS_values$TS

value_plot$data = alien_TS_values
value_plot = value_plot + labs(x = "TS", fill = "Alien")
value_plot + facet_wrap(~ paste("Subj", subjID))

alien_TS_obj = expand.grid(sad_alien = unique(alien_TS_values$sad_alien),
                           TS = unique(alien_TS_values$TS),
                           assess = "alien-same-TS")
alien_TS_obj$av_reward = c(6, 4, 5, 10,
                           2, 8, 7, 3,
                           7, 3, 3, 2)
alien_TS_obj$selected = alien_TS_obj$sad_alien
alien_TS_obj$assess = alien_TS_obj$TS

alien_TS_obj

value_plot$data = alien_TS_obj
value_plot
```
```{r Phase 3: Pick aliens, TSs, items}
# TDs
# Check that jsPsych is right
# That this code is right
# Plot means

# Figure out which TS went with which season for each subject
season_TS = ddply(subset(all_files, trial_type == "feed-aliens" & season %in% c("hot", "rainy", "cold")),
                  .(subjID, TS, season), summarize,
                  TS = TS[1])

# Fix item_chosen, item_left, and item_right columns
pick_aliens = subset(all_files, trial_type == "pick-aliens", select = c("subjID", "trial_index", "item_left", "item_right", "item_chosen", "assess"))
pick_aliens$item_chosen = as.character(pick_aliens$item_chosen)
for (row in 1:nrow(pick_aliens)) {
  chosen_item = as.character(pick_aliens$item_chosen[row])
  chosen_item_name = ifelse(is.na(chosen_item), NA, strsplit(strsplit(chosen_item, "#")[[1]][2], "-button")[[1]])
  pick_aliens$item_chosen[row] = chosen_item_name
}

pick_aliens = merge(pick_aliens,
                    season_TS,
                    by.x = c("subjID", "item_chosen"),
                    by.y = c("subjID", "season"), 
                    all = T)
pick_aliens$item_chosen = ifelse(pick_aliens$item_chosen %in% c("hot", "cold", "rainy"),
                                 paste("TS", as.character(pick_aliens$TS), sep = ""),
                                 pick_aliens$item_chosen)
pick_aliens$TS = NULL

pick_aliens = merge(pick_aliens,
                    season_TS,
                    by.x = c("subjID", "item_left"),
                    by.y = c("subjID", "season"), 
                    all = T)
pick_aliens$item_left = ifelse(pick_aliens$item_left %in% c("hot", "cold", "rainy"),
                                 paste("TS", as.character(pick_aliens$TS), sep = ""),
                                 pick_aliens$item_left)
pick_aliens$TS = NULL

pick_aliens = merge(pick_aliens,
                    season_TS,
                    by.x = c("subjID", "item_right"),
                    by.y = c("subjID", "season"), 
                    all = T)
pick_aliens$item_right = ifelse(pick_aliens$item_right %in% c("hot", "cold", "rainy"),
                                 paste("TS", as.character(pick_aliens$TS), sep = ""),
                                 pick_aliens$item_right)
pick_aliens$TS = NULL

# Add learnt values
alien_season_values = ddply(learnt_values, .(subjID, sad_alien, season), summarize,  # replace season with TS
                            av_reward = mean(reward, na.rm = T))
alien_season_values$selected = with(alien_season_values, paste("alien", as.numeric(as.character(sad_alien)) + 1, season, sep = ""))
alien_season_values$assess = "alien-same-season"
alien_season_values$sad_alien = alien_season_values$season = NULL
all_values = rbind(all_values, alien_season_values)

for (which in c("left", "right", "chosen")) {
  pick_aliens = merge(pick_aliens, all.x = T,
                      subset(all_values, select = c("subjID", "selected", "av_reward")),
                      by.x = c("subjID", paste("item_", which, sep = "")), by.y = c("subjID", "selected"))
  colnames(pick_aliens)[colnames(pick_aliens) == "av_reward"] = paste("value_", which, sep = "")
}
pick_aliens$value_unchosen = with(pick_aliens, ifelse(item_chosen == item_left, value_right, value_left))
pick_aliens$value_diff = with(pick_aliens, value_chosen - value_unchosen)

ggplot(pick_aliens, aes(trial_index, value_diff, color = assess)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  facet_grid(~ subjID)
```
```{r Rainbow season}

correct_values = ddply(subset(all_files, ACC == 1 & season %in% c("cold", "hot", "rainy")),
                      .(subjID, TS, sad_alien), summarize,
                      av_reward = mean(reward, na.rm = T),
                      item_chosen = item_chosen[1])
correct_values  # should agree with the TS!

rainbow_aliens = ddply(subset(rainbow, item_chosen != "NaN"),
                       c("subjID", "sad_alien", "TS", "item_chosen"),
                       summarize,
                       av_reward = 2 * sum(!is.na(item_chosen)))  # add column that indicates in how many trials subject chose each item for each alien

# Combine OPTIMAL CHOICES (not necessarily subject's choices) with subject's choices in the rainbow season
comb_dat = merge(correct_values,
                 rainbow_aliens,
                 by = c("subjID", "sad_alien", "TS", "item_chosen", "av_reward"), all = T)
comb_dat

# Plot OPTIMAL CHOICES in every season together with subject's choices in the rainbow season
ggplot(comb_dat, aes(sad_alien, item_chosen, color = TS, size = av_reward)) +
  geom_point() +
  theme(legend.position = "none") +
  facet_grid(paste("Subj", subjID) ~ paste("TS", TS))
```
```{r Start button}
```