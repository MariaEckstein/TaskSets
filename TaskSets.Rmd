---
title: "TaskSets"
author: "Maria Eckstein"
date: "July 19, 2017"
output: html_document
---

```{r Set parameters, load packages, etc.}

# TDs
# check if participants reactivate TS in rainbow phase, or just individual associations
  # order of choices -> does one TS0 action predict another?
  # "values" of choices -> do participants select the highest-valued items or the TS0 items?
  # It will be easier to do all of that when I have the new dataset because alien and item IDs will be better 

library("ggplot2"); library("plyr"); library("lme4"); library("reshape2")
theme_set(theme_bw())

n_aliens = 4
feed_aliens_phases = c("1InitialLearning", "2CloudySeason", "Refresher2", "Refresher3")
n_trials = data.frame(a = 13, b = 10, x = 7, d = 7)
colnames(n_trials) = paste("X", feed_aliens_phases, sep = "")
data_dir = "C:/Users/maria/MEGAsync/Berkeley/TaskSets/Data/"
plot_dir = file.path(data_dir, "plots")
if (!dir.exists(plot_dir)) {
  dir.create(plot_dir)
}
perf_criterion = 0.5  # participants who perform worse that that at the end of training (last 4 trials per alien) are excluded
gg_save = T
run_regression = T
```
```{r Read in data}
filenames = list.files(data_dir, pattern = "1...csv")
all_files = data.frame()
demographics = data.frame()
demo_row = 1

for (filename in filenames) {
  subj_file = read.csv(file = file.path(data_dir, filename), header = T, na.strings = c("", "NA", "NaN", "-1"))
  
  # Get demographics
  demos = gsub("[^A-Za-z0-9/]", "", as.character(subj_file$responses)[1])  # get rid of all funny characters
  Q0split = strsplit(strsplit(demos, "Q0")[[1]][2], "Q1")[[1]][1]
  Q1split = strsplit(strsplit(demos, "Q1")[[1]][2], "Q2")[[1]][1]
  Q1split = gsub("[^0-9/]", "", Q1split)  # remove non-numbers
  Q2split = strsplit(strsplit(demos, "Q2")[[1]][2], "Q3")[[1]][1]
  Q2split = gsub("[^0-9/]", "", Q2split)  # remove non-numbers
  Q3split = strsplit(demos, "Q3")[[1]][2]
  
  # Subj ID & sex
  subjID = as.numeric(Q0split)
  demographics[demo_row, "subjID"] = subjID
  demographics[demo_row, "sex"] = Q3split
  
  # Date of birth
  month = as.numeric(strsplit(Q1split, "/")[[1]][1])
  day = as.numeric(strsplit(Q1split, "/")[[1]][2])
  year = as.numeric(strsplit(Q1split, "/")[[1]][3])
  if (nchar(year) == 2) {
    year = paste("19", year, sep = "")
  }
  if (year > 2010 | year < 1950) {
    year = 1995
  }
  demographics[demo_row, "dob"] = paste(year, month, day, sep = "-")
  
  # Testing date
  month = as.numeric(strsplit(Q2split, "/")[[1]][1])
  day = as.numeric(strsplit(Q2split, "/")[[1]][2])
  year = as.numeric(strsplit(Q2split, "/")[[1]][3])
  if (month == "19") {
    month = "10"
  }
  if (nchar(year) == 2) {
    year = paste("20", year, sep = "")
  }
  if (year <= 2017 | year > 2018) {
    year = 2018
  }
  demographics[demo_row, "testing_date"] = paste(year, month, day, sep = "-")
  demo_row = demo_row + 1

  # Get all_files
  subj_file$subjID = subjID
  subj_file = subset(subj_file, select = -c(responses, internal_node_id, view_history))

  # Add trial column: counter within blocks
  subj_file$trial = NA  # trial within block / season
  for (row in 2:nrow(subj_file)) {
    if (is.na(subj_file$season[row])) {
      trial = NA
    } else {
      if (is.na(subj_file$season[row-1])) {
        trial = 1
      } else {
        trial = trial + 1
      }
    }
    subj_file$trial[row] = trial
  }
  
  # Add alien_trial and repetition columns (alien_trial: how often has this alien been presented in this season?; repetition: How often has this season been presented?)
  subj_file$alien_trial = NA
  subj_file$repetition = NA
  # Create counters for seasons and alien-season combinations
  season_counter = data.frame(training = 0,
                              hot = 0, cold = 0, rainy = 0,
                              hot_cloudy = 0, cold_cloudy = 0, rainy_cloudy = 0,
                              rainbow = 0)
  alien_season_counter = data.frame(training = rep(0, n_aliens),
                                    hot = rep(0, n_aliens), cold = rep(0, n_aliens), rainy = rep(0, n_aliens),
                                    hot_cloudy = rep(0, n_aliens), cold_cloudy = rep(0, n_aliens), rainy_cloudy = rep(0, n_aliens),
                                    rainbow = rep(0, n_aliens))

  for (row in 1:nrow(subj_file)) {
    sad_alien = subj_file$sad_alien[row] + 1  # Python starts at 0, I start at 1
    if (!is.na(sad_alien)) {
      season = as.character(subj_file$season[row])
      # Update counters, add new count to subj_file
      if (row > 1) {
        if (is.na(subj_file$season[row-1])) {
          season_counter[season] = season_counter[season] + 1
        }
      }
      subj_file$repetition[row] = season_counter[season][[1]]
      alien_season_counter[sad_alien, season] = alien_season_counter[sad_alien, season] + 1
      subj_file$alien_trial[row] = alien_season_counter[sad_alien, season]
    }
  }
  all_files = rbind(all_files, subj_file)
}

# More beautification
all_files$subjID = as.numeric(as.character(all_files$subjID))
all_files$sad_alien = factor(all_files$sad_alien)
all_files$ACC = ifelse(all_files$correct == "true", 1, 0)
all_files$time_elapsed = all_files$points0 = all_files$points1 = all_files$points2 = NULL  # Remove unnecessary columns
all_files$TS = as.character(all_files$TS)
all_files$TS[is.na(all_files$TS)] = as.character(all_files$season[is.na(all_files$TS)])  # if column TS is NA, replace it with season column
all_files$TS = factor(all_files$TS)
all_files$reward[is.na(all_files$key)] = 0

summary(all_files)
demographics

ddply(subset(all_files, season = "rainy"), .(subjID, TS, sad_alien, item_chosen), summarize,
      rew = mean(reward, na.rm = T))
```
```{r Clean data and create summary dataframe}

# Exclude subjects who don't reach criterion in training block
criterion_dat = subset(all_files, season == "training" & alien_trial %in% 7:10)
perf_dat = ddply(criterion_dat, .(subjID), summarize,
                 ACC = mean(ACC, na.rm = T))
plot(perf_dat$ACC)
perf_dat$below_criterion = perf_dat$ACC < perf_criterion
(chance_performers = subset(perf_dat, below_criterion == T))
all_files = subset(all_files, !subjID %in% chance_performers$subjID)
```
```{r demographics}
demographics$age = with(demographics, as.Date(testing_date) - as.Date(dob))
nrow(demographics)  # number of participants
demographics = subset(demographics, subjID %in% unique(all_files$subjID))
nrow(demographics)  # number of participants after removing chance performaners
as.numeric(mean(demographics$age) / 365.242)  # mean age in years
as.numeric(sd(demographics$age) / 365.242)  # age sd
plot(as.numeric(demographics$age) / 365.242)  # plot to check
```
```{r Calculate learned values for aliens, seasons, items}
learnt_values = subset(all_files, phase %in% c("1InitialLearning", "Refresher2", "Refresher3") & !is.na(item_chosen))
alien_values = ddply(learnt_values, .(subjID, phase, sad_alien_name), summarize,
                     av_reward = mean(reward, na.rm = T))
alien_values$selected = alien_values$sad_alien_name  # paste("alien", as.numeric(as.character(alien_values$sad_alien))+1, sep = "")
alien_values$assess = "Alien"
alien_values$sad_alien_name = NULL

TS_values = ddply(learnt_values, .(subjID, phase, TS), summarize,
                      av_reward = mean(reward, na.rm = T))
TS_values$selected = paste("TS", TS_values$TS, sep = "")
TS_values$assess = "TS"
TS_values$TS = NULL

item_values = ddply(learnt_values, .(subjID, phase, item_chosen_name), summarize,
                    av_reward = mean(reward, na.rm = T))
item_values$selected = item_values$item_chosen
item_values$assess = "Item"
item_values$item_chosen_name = NULL

alien_TS_values = ddply(learnt_values, .(subjID, phase, TS, sad_alien_name), summarize,
                        av_reward = mean(reward, na.rm = T))
alien_TS_values$selected = with(alien_TS_values, paste(sad_alien_name, "TS", TS, sep = ""))  # with(alien_TS_values, paste("alien", as.numeric(as.character(sad_alien))+1, "TS", TS, sep = ""))
alien_TS_values$assess = "AlienSameTS"

all_values = rbind(alien_values, TS_values, item_values, subset(alien_TS_values, select = -c(TS, sad_alien_name)))
all_values
```
```{r Calculate final performance}
dat = subset(all_files, phase == "Refresher2")
alien_perf = ddply(dat, .(subjID, sad_alien_name), summarize,
                   av_ACC = mean(ACC, na.rm = T))
alien_perf$selected = alien_perf$sad_alien_name
alien_perf$assess = "Alien"
alien_perf$sad_alien_name = NULL

TS_perf = ddply(dat, .(subjID, TS), summarize,
                av_ACC = mean(ACC, na.rm = T))
TS_perf$selected = paste("TS", TS_perf$TS, sep = "")
TS_perf$assess = "TS"
TS_perf$TS = NULL

item_perf = ddply(dat, .(subjID, item_chosen_name), summarize,
                  av_ACC = mean(ACC, na.rm = T))
item_perf$selected = item_perf$item_chosen
item_perf$assess = "Item"
item_perf$item_chosen_name = NULL

alien_TS_perf = ddply(dat, .(subjID, TS, sad_alien_name), summarize,
                      av_ACC = mean(ACC, na.rm = T))
alien_TS_perf$selected = with(alien_TS_perf, paste(sad_alien_name, "TS", TS, sep = ""))
alien_TS_perf$assess = "AlienSameTS"

all_perf = rbind(alien_perf, TS_perf, item_perf, subset(alien_TS_perf, select = -c(TS, sad_alien_name)))
all_perf$phase = "Refresher2"
unique(all_perf$selected)

all_values_perf = merge(all_values, all_perf, all = T)
all_values_perf
```
```{r Create pick_aliens data}

# all_values: what are the experiences values of each alien, item, TS, and each alien-TS combo?
# all_values = rbind(subset(alien_TS_values, phase == "Refresher2", select = c("subjID", "assess", "selected", "av_reward")),
#                    subset(alien_values, phase == "Refresher2", select = c("subjID", "assess", "selected", "av_reward")),
#                    subset(TS_values, phase == "Refresher2", select = c("subjID", "assess", "selected", "av_reward")),
#                    subset(item_values, phase == "Refresher2", select = c("subjID", "assess", "selected", "av_reward")))

# all_perf: how well do participants know each mapping going into the competition phase?

# season_TS: which season corresponds to each TS for each subject?
season_TS = ddply(subset(all_files, trial_type == "feed-aliens" & season %in% c("hot", "rainy", "cold")),
                  .(subjID, TS, season), summarize,
                  TS = TS[1])

# pick_aliens: Which choices did subjects make in phase 3?
pick_aliens = subset(all_files, trial_type == "pick-aliens", select = c("subjID", "trial_index", "item_left_name", "item_right_name", "item_chosen_name", "assess"))

### Remove "-button"
# pick_aliens$item_chosen = as.character(pick_aliens$item_chosen)
# for (row in 1:nrow(pick_aliens)) {
#   chosen_item = as.character(pick_aliens$item_chosen[row])
#   chosen_item_name = ifelse(is.na(chosen_item), NA, strsplit(strsplit(chosen_item, "#")[[1]][2], "-button")[[1]])
#   pick_aliens$item_chosen[row] = chosen_item_name
# }
# pick_aliens$item_chosen[pick_aliens$item_chosen == "NaN"] = NA

### Add rows with TS0, TS1, TS2 instead of hot, cold, rainy to pick_aliens
for (subj in levels(factor(all_files$subjID))) {
  add = subset(pick_aliens, subjID == subj & assess %in% c("season", "alien-same-season"))
  for (seas in c("hot", "cold", "rainy")) {
    sub = paste("TS", subset(season_TS, subjID == subj & season == seas)$TS, sep = "")
    add$item_right_name = gsub(seas, sub, add$item_right_name)
    add$item_left_name = gsub(seas, sub, add$item_left_name)
    add$item_chosen_name = gsub(seas, sub, add$item_chosen_name)
    add$assess = as.character(add$assess)
    add$assess = gsub("season", "TS", add$assess)
  }
  pick_aliens = rbind(pick_aliens, add)
}
pick_aliens$item_unchosen_name = with(pick_aliens, ifelse(as.character(item_chosen_name) == as.character(item_right_name), as.character(item_left_name), as.character(item_right_name)))
pick_aliens$item_left_name = pick_aliens$item_right_name = NULL

### Remove the "_name" from chosen and unchosen columns
colnames(pick_aliens)[colnames(pick_aliens) %in% c("item_chosen_name", "item_unchosen_name")] = c("item_chosen", "item_unchosen")

### Add columns for the values of each trial's chosen and unchosen items
for (col in c("unchosen", "chosen")) {
  pick_aliens = merge(pick_aliens, all.x = T,
                      subset(all_values_perf, phase == "Refresher2", select = c("subjID", "selected", "av_reward", "av_ACC")),
                      by.x = c("subjID", paste("item_", col, sep = "")), by.y = c("subjID", "selected"))
  colnames(pick_aliens)[colnames(pick_aliens) %in% "av_reward"] = paste("value_", col, sep = "")
  colnames(pick_aliens)[colnames(pick_aliens) %in% "av_ACC"] = paste("ACC_", col, sep = "")
}
pick_aliens = pick_aliens[order(pick_aliens$subjID, pick_aliens$assess, pick_aliens$item_chosen, pick_aliens$item_unchosen),]
pick_aliens$selected_better = pick_aliens$value_chosen > pick_aliens$value_unchosen
pick_aliens$selected_better_obj = NA
pick_aliens$selected_better_obj[pick_aliens$assess == "TS"] = with(subset(pick_aliens, assess == "TS"), item_chosen == "TS0" | (item_chosen == "TS1" & item_unchosen == "TS2"))

pick_aliens_sum = ddply(subset(pick_aliens, !is.na(assess)),
                        .(subjID, assess), summarize,
                        value_chosen = mean(value_chosen, na.rm = T),
                        value_unchosen = mean(value_unchosen, na.rm = T),
                        value_diff = mean(value_chosen - value_unchosen, na.rm = T),
                        ACC_diff = mean(ACC_chosen - ACC_unchosen, na.rm = T),
                        selected_better = mean(selected_better, na.rm = T),
                        selected_better_obj = mean(selected_better_obj, na.rm = T))
```
```{r Plot competition phase and t-tests}
gg_pick_aliens_value = ggplot(subset(pick_aliens_sum, assess %in% c("alien", "alien-same-TS", "item", "TS")), aes(assess, value_diff, color = subjID)) +
  stat_summary(fun.y = "mean", geom = "bar") +
  stat_summary(fun.data = "mean_cl_normal", geom = "pointrange") +
  labs(x = "", y = "Value chosen minus unchosen", color = "Participant") +
  geom_point(position = "jitter", alpha = 0.3)
gg_pick_aliens_ACC = gg_pick_aliens_value +
  aes(assess, ACC_diff) +
  labs(x = "", y = "ACC chosen minus unchosen")

gg_pick_aliens_ch = gg_pick_aliens_value + aes(y = value_chosen)
gg_pick_aliens_unch = gg_pick_aliens_value + aes(y = value_unchosen)

mean(subset(pick_aliens_sum, assess == "TS")$selected_better)
t.test(subset(pick_aliens_sum, assess == "TS")$selected_better - 0.5)
mean(subset(pick_aliens_sum, assess == "item")$selected_better)
t.test(subset(pick_aliens_sum, assess == "item")$selected_better - 0.5)
mean(subset(pick_aliens_sum, assess == "TS")$selected_better_obj)
t.test(subset(pick_aliens_sum, assess == "TS")$selected_better_obj - 0.5)
mean(subset(pick_aliens_sum, assess == "TS")$value_chosen)
mean(subset(pick_aliens_sum, assess == "TS")$value_unchosen)
t.test(subset(pick_aliens_sum, assess == "TS")$value_chosen - subset(pick_aliens_sum, assess == "TS")$value_unchosen)
mean(subset(pick_aliens_sum, assess == "item")$selected_better)
mean(subset(pick_aliens_sum, assess == "item")$value_unchosen)
mean(subset(pick_aliens_sum, assess == "item")$value_chosen)
t.test(subset(pick_aliens_sum, assess == "item")$value_chosen - subset(pick_aliens_sum, assess == "item")$value_unchosen)
t.test(subset(pick_aliens_sum, assess == "item")$selected_better - 0.5)

gg_pick_aliens_value_subj = ggplot(subset(pick_aliens), aes(trial_index, value_chosen - value_unchosen, color = assess)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  labs(x = "Trial", y = "Value chosen minus unchosen", color = "") +
  facet_wrap(~ subjID)
gg_pick_aliens_ACC_subj = gg_pick_aliens_value_subj +
  aes(trial_index, ACC_chosen - ACC_unchosen, color = assess) +
  labs(x = "Trial", y = "ACC chosen minus unchosen")

cute_dat_chosen = ddply(subset(pick_aliens, !is.na(item_chosen)),
                        .(subjID, assess, item_chosen), summarize,
                        count_chosen = length(item_chosen))
cute_dat_unchosen = ddply(subset(pick_aliens, !is.na(item_chosen)),
                          .(subjID, assess, item_unchosen), summarize,
                          count_unchosen = length(item_unchosen))
cute_dat = merge(cute_dat_chosen, cute_dat_unchosen, all = T,
                 by.x = c("subjID", "assess", "item_chosen"),
                 by.y = c("subjID", "assess", "item_unchosen"))
cute_dat$count_chosen[is.na(cute_dat$count_chosen)] = 0
cute_dat$count_unchosen[is.na(cute_dat$count_unchosen)] = 0
cute_dat$chosen_minus_unchosen = with(cute_dat, count_chosen - count_unchosen)

gg_pick_aliens_raw_ch = ggplot(cute_dat, aes(assess, count_chosen, color = item_chosen, group = item_chosen)) +
  # geom_point(position = position_dodge(width = 0.9), alpha = 0.05, color = "black") +
  stat_summary(fun.data = mean_cl_normal, geom = "pointrange", position = position_dodge(width = 0.9)) +
  labs(x = "", y = "# Chosen", color = "")
gg_pick_aliens_raw_unch = gg_pick_aliens_raw_ch +
  aes(y = count_unchosen) +
  labs(y = "# Unchosen")
gg_pick_aliens_raw_diff = gg_pick_aliens_raw_ch +
  aes(y = chosen_minus_unchosen) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  labs(y = "# Chosen - # Unchosen")

alien_TS = subset(cute_dat, assess == "alien-same-season")
alien_TS$alien = substring(alien_TS$item_chosen, 1, 6)
alien_TS$season = substring(alien_TS$item_chosen, 7)

ggplot(alien_TS, aes(season, chosen_minus_unchosen, color = alien)) +
  stat_summary(fun.data = mean_cl_normal, geom = "pointrange")

if (gg_save) {
  ggsave(file.path(plot_dir, "4gg_pick_aliens_value.png"), gg_pick_aliens_value, width = 4, height = 3)
  ggsave(file.path(plot_dir, "4gg_pick_aliens_ch.png"), gg_pick_aliens_ch, width = 4, height = 3)
  ggsave(file.path(plot_dir, "4gg_pick_aliens_unch.png"), gg_pick_aliens_unch, width = 4, height = 3)
  ggsave(file.path(plot_dir, "4gg_pick_aliens_ACC.png"), gg_pick_aliens_ACC, width = 4, height = 3)
  ggsave(file.path(plot_dir, "4gg_pick_aliens_value_subj.png"), gg_pick_aliens_value_subj, width = 15, height = 15)
  ggsave(file.path(plot_dir, "4gg_pick_aliens_ACC_subj.png"), gg_pick_aliens_ACC_subj, width = 15, height = 15)
  ggsave(file.path(plot_dir, "4gg_pick_aliens_raw_ch.png"), gg_pick_aliens_raw_ch, width = 8, height = 3)
  ggsave(file.path(plot_dir, "4gg_pick_aliens_raw_unch.png"), gg_pick_aliens_raw_unch, width = 8, height = 3)
  ggsave(file.path(plot_dir, "4gg_pick_aliens_raw_diff.png"), gg_pick_aliens_raw_diff, width = 8, height = 3)
}
```
```{r Plot learned values and true objective values}
value_plot = ggplot(subset(all_values_perf, assess != "AlienSameTS"), aes(assess, av_reward, fill = selected)) +
  stat_summary(fun.data = "mean_cl_normal", geom = "bar", position = "dodge") +
  stat_summary(fun.data = "mean_cl_normal", geom = "pointrange", position = position_dodge(width = 0.9)) +
  labs(y = "Average reward / trial", x = "", fill = "") +
  scale_y_continuous(breaks = seq(0, 10, 2))#+
  # coord_flip()
value_plot_phase = value_plot + facet_wrap(~ phase)
value_plot_subj = value_plot + facet_wrap(phase ~ paste("Subj", subjID))

alien_plot = value_plot + aes(x = TS, fill = sad_alien) + labs(fill = "Alien") + facet_wrap(~ phase)
alien_plot$data = alien_TS_values
alien_plot2 = alien_plot + facet_wrap(~ paste("Subj", subjID))

# True objective values
aliens = sort(unique(as.numeric(as.character(all_files$sad_alien[!is.na(all_files$sad_alien)]))))
TSs = sort(unique(all_files$TS[all_files$phase == "1InitialLearning" & !is.na(all_files$TS)]))
alien_TS_obj = expand.grid(sad_alien = aliens,
                           TS = TSs)
alien_TS_obj$av_reward = c(6, 4, 5, 10,
                           2, 8, 7, 3,
                           7, 3, 3, 2)
alien_TS_obj$selected = factor(alien_TS_obj$sad_alien)
alien_TS_obj$assess = factor(alien_TS_obj$TS)

true_values = value_plot + labs(title = "True underlying TS", fill = "Alien")
true_values$data = alien_TS_obj

if (gg_save) {
  ggsave(file.path(plot_dir, "0value_plot.png"), value_plot_phase, width = 9, height = 3)
  ggsave(file.path(plot_dir, "0alien_plot.png"), alien_plot, width = 9, height = 3)
  ggsave(file.path(plot_dir, "0alien_plot2.png"), alien_plot2, width = 15, height = 15)
  ggsave(file.path(plot_dir, "0true_values.png"), true_values, width = 3.5, height = 3)
  ggsave(file.path(plot_dir, "0value_plot_subj.png"), value_plot_subj, width = 15, height = 15)
}
```
```{r Prepare learning data for plotting (feed_aliens)}
# Plotting data: feed_aliens
feed_aliens = subset(all_files, trial_type == "feed-aliens")

## Add objective stimulus-response values and TS values
feed_aliens = merge(feed_aliens, all.x = T,
                    subset(alien_TS_obj, select = c("sad_alien", "TS", "av_reward")),
                    by = c("sad_alien", "TS"))

feed_aliens = merge(feed_aliens, all.x = T,
                    ddply(alien_TS_obj, .(TS), summarize, TS_value = mean(av_reward)),
                    by = "TS")

## Add "subjective" values (experienced average rewards during refresher 1)
feed_aliens = merge(feed_aliens, all.x = T,
                    subset(alien_TS_values, phase == "1InitialLearning", select = c("subjID", "sad_alien", "TS", "av_reward")),
                    by = c("subjID", "sad_alien", "TS"),
                    suffixes = c("", "_subj"))

feed_aliens$alien_trial_sum = NA
feed_aliens = feed_aliens[order(feed_aliens$subjID, feed_aliens$phase, feed_aliens$trial_index, feed_aliens$sad_alien, feed_aliens$TS),]

for (phas in feed_aliens_phases) {
  # Let each phase start at alien_trial == 1
  subs = feed_aliens$phase == phas & !is.na(feed_aliens$alien_trial)
  feed_aliens[subs, "alien_trial"] = feed_aliens[subs, "alien_trial"] - feed_aliens[subs, "alien_trial"][1] + 1
  feed_aliens[subs,]
  
  # Add alien_trial_sum: starts at 1 every time a TS is repeated
  feed_aliens[subs, "alien_trial_sum"] = feed_aliens[subs, "alien_trial"]
  n_tr = as.numeric(n_trials[paste("X", phas, sep = "")])
  subs2 = feed_aliens$phase == phas & feed_aliens$alien_trial_sum > n_tr
  while (any(feed_aliens[subs2, "alien_trial_sum"] > n_tr)) {
    feed_aliens[subs2, "alien_trial_sum"] = feed_aliens[subs2, "alien_trial_sum"] - n_tr
    subs2 = feed_aliens$phase == phas & feed_aliens$alien_trial_sum > n_tr
  }
}
```
```{r Prepare learning data for regressions (regr_dat)}
# Regression data: regr_dat
## Bring in the right order for regression: each line must be the predictor of the immediate next line!
feed_aliens = feed_aliens[order(feed_aliens$subjID, feed_aliens$phase, feed_aliens$sad_alien, feed_aliens$TS, feed_aliens$alien_trial),]
regr_dat = subset(feed_aliens, select = c("subjID", "phase", "sad_alien", "TS", "reward", "av_reward", "TS_value", "trial", "alien_trial_sum", "alien_trial", "repetition", "ACC"))

ACC_1back_self = c(NA, regr_dat$ACC[1:length(regr_dat$ACC)-1])
ACC_1back_self[regr_dat$alien_trial_sum == 1] = NA
regr_dat$ACC_1back_self = ACC_1back_self

rew_1back_self = c(NA, regr_dat$reward[1:length(regr_dat$reward)-1])
rew_1back_self[regr_dat$alien_trial_sum == 1] = NA
regr_dat$rew_1back_self = rew_1back_self

others_regr_dat = data.frame()
for (alien in unique(regr_dat$sad_alien)) {
  alien_regr_dat = ddply(subset(regr_dat, sad_alien != alien),
                    .(subjID, phase, TS, alien_trial, alien_trial_sum), summarize,
                    ACC_others = mean(ACC, na.rm = T))
  alien_regr_dat$sad_alien = alien
  others_regr_dat = rbind(others_regr_dat, alien_regr_dat)
}
others_regr_dat = others_regr_dat[order(others_regr_dat$subjID, others_regr_dat$phase, others_regr_dat$sad_alien, others_regr_dat$TS, others_regr_dat$alien_trial),]
ACC_1back_others = c(NA, others_regr_dat$ACC_others[1:length(others_regr_dat$ACC_others)-1])
ACC_1back_others[others_regr_dat$alien_trial_sum == 1] = NA
others_regr_dat$ACC_1back_others = ACC_1back_others

regr_dat = merge(others_regr_dat, regr_dat,  # sanity check: cloudy regr_dat should have 12000 rows: 50 subj * 20 alien_trials * 3 TS * 4 sad_aliens
                 by = c("subjID", "phase", "TS", "alien_trial", "alien_trial_sum", "sad_alien"))
regr_dat$TS = factor(regr_dat$TS)
regr_dat$sad_alien = factor(regr_dat$sad_alien)
```
```{r Plot first trials: How well do participants infer TS}
for (phas in feed_aliens_phases) {
  
  # Get data
  dat = subset(regr_dat, phase == phas & alien_trial_sum == 1)
  # Add columns
  dat = dat[order(dat$subjID, dat$TS, dat$alien_trial, dat$trial),]
  for (n in 1:(n_aliens-1)) {
    col = paste("back", n, sep = "")
    dat[,col] = c(rep(NA, n), dat$ACC[1:(length(dat$ACC)-n)])
    dat[dat$trial <= n, col] = NA
  }
  # cum_ACC = How many trials has participants gotten right up until (but not including) the current trial?
  dat$cum_ACC = rowSums(dat[,paste("back", 1:(n_aliens-1), sep = "")], na.rm = T)
  dat[,paste("back", 1:n_aliens, sep = "")] = NULL
  
  dat$value = round(dat$av_reward / 2) * 2
  dat$evidence = dat$cum_ACC
  dat$evidence[dat$evidence >= 1] = "1+"
  
  if (phas == "1InitialLearning") {  # remove the very first encounter of a TS because participants don't know anything yet
    dat = subset(dat, alien_trial > 1)
  }
  
  sum_dat = ddply(dat, .(subjID, evidence), summarize,
                  ACC = mean(ACC, na.rm = T))
  ggplot(sum_dat, aes(ACC)) +
    geom_histogram(stat = "density", position = "identity", alpha = 0.5) +
    facet_grid(~ evidence)
  mean(subset(sum_dat, evidence == "0")$ACC)  # mean of evidence 0
  mean(subset(sum_dat, evidence == "1+")$ACC)  # mean of evidence 1+
  t.test(subset(sum_dat, evidence == "0")$ACC - 1/3)  # participants perform above chance even in the first trial...??
  t.test(subset(sum_dat, evidence == "0")$ACC - subset(sum_dat, evidence == "1+")$ACC)  # sig. diff. betwe. evid. 0 & 1+
  
  gg_value_guess_paper = ggplot(sum_dat, aes(evidence, 100 * ACC)) +
    stat_summary(fun.data = mean_cl_normal, geom = "bar") +
    stat_summary(fun.data = mean_cl_normal, geom = "pointrange") +
    labs(x = "Prev. correct", y = "% correct", color = "Value")
  
  gg_value_guess = ggplot(dat, aes(cum_ACC, 100 * ACC)) +  # , color = cum_ACC_1back, group = cum_ACC_1back
    stat_summary(fun.data = mean_cl_normal, geom = "bar") +
    stat_summary(fun.data = mean_cl_normal, aes(color = TS, group = TS), geom = "pointrange") +
    stat_summary(fun.data = mean_cl_normal, aes(color = TS, group = TS), geom = "line") +
    geom_hline(yintercept = 100/3, linetype = "dotted") +
    coord_cartesian(ylim = c(0, 100)) +
    labs(x = "# of previous correct trials", y = "% correct", color = "TS")
  
  if (gg_save) {
    ggsave(paste(plot_dir, "/2gg_value_guess_", phas, ".png", sep = ""), gg_value_guess, width = 3, height = 3)
    ggsave(paste(plot_dir, "/2gg_value_guess_paper_", phas, ".png", sep = ""), gg_value_guess_paper, width = 1.5, height = 3)
  }
}
```
```{r Plot overall learning}
# Plot learning curves (and RTs) overall
overall_learning_curves = ggplot(subset(feed_aliens),
                                 aes(trial_index, 100 * ACC, color = phase, group = phase)) +
  stat_summary(fun.data = mean_cl_normal, geom = "pointrange") +
  geom_hline(yintercept = 100/3, linetype = "dotted") +
  labs(x = "Trial", y = "% correct")

overall_learning_curves_subj = overall_learning_curves + facet_wrap(~ subjID)
overall_RTs = overall_learning_curves + aes(trial_index, rt, color = phase) + labs(x = "Trial", y = "Response time (msec)")

if (gg_save) {
  ggsave(file.path(plot_dir, "1overall_learning_curves.png"), overall_learning_curves, width = 25, height = 3)
  ggsave(file.path(plot_dir, "1overall_learning_curves_subj.png"), overall_learning_curves_subj, width = 25, height = 25)
  ggsave(file.path(plot_dir, "1overall_RTs.png"), overall_RTs, width = 25, height = 3)
}
```
```{r Create perseverance data}
# Get data that shows which choices correspond to one of the 3 TS, and which don't
correct_TS = ddply(subset(all_files, ACC == 1 & season %in% c("cold", "hot", "rainy")),
                      .(TS, sad_alien), summarize,
                      item_chosen = item_chosen[1])
correct_TS$ACC = 1
all_TS = expand.grid(TS = unique(correct_TS$TS), sad_alien = unique(correct_TS$sad_alien), item_chosen = unique(correct_TS$item_chosen))
corincor_TS = merge(correct_TS, all_TS, all.y = T)
corincor_TS$ACC[is.na(corincor_TS$ACC)] = 0

# Add accuracy for each TS to each trial
for (TSi in unique(corincor_TS$TS)) {
  feed_aliens = merge(feed_aliens, subset(corincor_TS, TS == TSi, select = -TS),
        by = c("sad_alien", "item_chosen"),
        all.x = T,
        suffixes = c("", TSi))
  col = paste("ACC", TSi, sep = "")
}
feed_aliens$ACCNone = with(feed_aliens, ACC0 + ACC1 + ACC2 == 0)  # Actions that are incorrect in each of the three TS
feed_aliens = feed_aliens[order(feed_aliens$subjID, feed_aliens$trial_index),]

# Add prev_TS
feed_aliens$prev_TS = NA
feed_aliens$prev_prev_TS = NA
feed_aliens$prev_notTS = NA
prev_TS = "training"
prev_prev_TS = "training"
prev_row = "training"
for (row in 1:nrow(feed_aliens)) {
  TS_row = as.character(feed_aliens$TS[row])
  if (is.na(TS_row)) {
    print("skip!")
  } else if (TS_row != prev_row) {
    prev_prev_TS = prev_TS
    prev_TS = prev_row
  }
  if (prev_TS == 0) {
    prev_notTS = ifelse(TS_row == 1, 2, 1)
  } else if (prev_TS == 1) {
    prev_notTS = ifelse(TS_row == 2, 0, 2)
  } else if (prev_TS == 2) {
    prev_notTS = ifelse(TS_row == 0, 1, 0)
  } else {
    prev_notTS = NA
  }
  feed_aliens$prev_TS[row] = prev_TS
  feed_aliens$prev_prev_TS[row] = prev_prev_TS
  feed_aliens$prev_notTS[row] = prev_notTS
  prev_row = TS_row
}
feed_aliens$prev_TS[feed_aliens$prev_TS %in% c("training", "rainbow")] = NA
feed_aliens$prev_prev_TS[feed_aliens$prev_prev_TS %in% c("training", "rainbow")] = NA

subset(feed_aliens, select = c("TS", "prev_TS", "prev_prev_TS", "prev_notTS"))

# Add ACC_prev_TS and ACC_prev_notTS
feed_aliens$ACC_prev_TS = NA
feed_aliens$ACC_prev_notTS = NA
feed_aliens$ACC_prev_prev_TS = NA
for (TSi in unique(feed_aliens$TS)) {
  rows_prev = !is.na(feed_aliens$prev_TS) & feed_aliens$prev_TS == TSi
  rows_prev_not = !is.na(feed_aliens$prev_notTS) & feed_aliens$prev_notTS == TSi
  rows_prev_prev = !is.na(feed_aliens$prev_prev_TS) & feed_aliens$prev_prev_TS == TSi
  col = paste("ACC", TSi, sep = "")
  feed_aliens[rows_prev, "ACC_prev_TS"] = feed_aliens[rows_prev, col]
  feed_aliens[rows_prev_not, "ACC_prev_notTS"] = feed_aliens[rows_prev_not, col]
  feed_aliens[rows_prev_prev, "ACC_prev_prev_TS"] = feed_aliens[rows_prev_prev, col]
}
```
```{r Plot perseverance mistakes and run regression models}
for (phas in feed_aliens_phases) {
  
  dat = subset(feed_aliens, phase == phas)
  
  dat_l = melt(subset(dat, select = -ACC), measure.vars = c("ACC0", "ACC1", "ACC2", "ACCNone"), variable.name = "ACC_TS", value.name = "ACC")
  dat_l$current_TS = F
  for (TSi in 0:2) {
    dat_l$current_TS[dat_l$TS == TSi & dat_l$ACC_TS == paste("ACC", TSi, sep = "")] = T
  }
  dat_l$facet = ""
  
  gg_otherTS_ACC = ggplot(dat_l, aes(alien_trial, 100 * ACC, color = factor(ACC_TS))) +
    stat_summary(fun.data = mean_cl_normal, geom = "pointrange") +
    geom_hline(yintercept = 100/3, linetype = "dotted") +
    geom_hline(yintercept = 200/12, linetype = "dotted", color = "purple") +
    coord_cartesian(y = c(0, 100)) +
    labs(x = "Trial", y = "% chosen", color = "") +
    facet_grid(~ TS)
  
  gg_otherTS_ACC_value = ggplot(dat_l, aes(alien_trial, 100 * ACC, color = factor(av_reward), group = sad_alien)) +
    stat_summary(fun.data = mean_cl_normal, geom = "pointrange") +
    geom_hline(yintercept = 100/3, linetype = "dotted") +
    coord_cartesian(y = c(0, 100)) +
    labs(x = "Trial", y = "% chosen", color = "Value") +
    facet_grid(factor(dat_l$TS, labels = c("TS0", "TS1", "TS2")) ~ ACC_TS)
  
  gg_otherTS_ACC_alien = gg_otherTS_ACC_value +
    aes(color = factor(sad_alien)) +
    labs(color = "Alien")
  
  dat_l2 = melt(dat, measure.vars = c("ACC", "ACC_prev_TS", "ACC_prev_notTS"), variable.name = "ACC_TS", value.name = "ACC")  # , "ACC_prev_prev_TS"
  dat_l2$facet = ""
  gg_prevTS_ACC = gg_otherTS_ACC_value +
    aes(color = factor(av_reward)) +
    facet_grid(TS ~ ACC_TS)
  gg_prevTS_ACC$data = dat_l2
  
  # Remove trials that count as "intrusion errors" although they are correct in the current TS
  dat_l$ACC[dat_l$sad_alien == 3 & dat_l$TS == 0 & dat_l$ACC_TS == "ACC2"] = NA
  dat_l$ACC[dat_l$sad_alien == 3 & dat_l$TS == 2 & dat_l$ACC_TS == "ACC0"] = NA
  dat_l$ACC[dat_l$sad_alien == 0 & dat_l$TS == 2 & dat_l$ACC_TS == "ACC1"] = NA
  dat_l$ACC[dat_l$sad_alien == 0 & dat_l$TS == 1 & dat_l$ACC_TS == "ACC2"] = NA
  
  dat_l2$ACC[dat_l2$sad_alien == 3 & dat_l2$TS == 0 & dat_l2$ACC_TS == "ACC_prev_TS"] = NA
  dat_l2$ACC[dat_l2$sad_alien == 3 & dat_l2$TS == 2 & dat_l2$ACC_TS == "ACC_prev_TS"] = NA
  dat_l2$ACC[dat_l2$sad_alien == 0 & dat_l2$TS == 2 & dat_l2$ACC_TS == "ACC_prev_TS"] = NA
  dat_l2$ACC[dat_l2$sad_alien == 0 & dat_l2$TS == 1 & dat_l2$ACC_TS == "ACC_prev_TS"] = NA
  
  # How often do intrusions occur compared to just random mistakes?  (Question: Am I counting errors twice that are correct in more than one TS??)
  dat_l$none_or_TS = ifelse(dat_l$ACC_TS == "ACCNone", "None", "TS")
  subj_av = ddply(subset(dat_l, !current_TS), .(subjID, none_or_TS), summarize,
        ACC = sum(ACC, na.rm = T))
  subj_av = reshape(subj_av, direction = "wide", timevar = "none_or_TS", idvar = "subjID")
  subj_av$fraction_TS_errors = with(subj_av, ACC.TS / (ACC.None + ACC.TS))
  plot(subj_av$fraction_TS_errors - 6/8)
  t.test(subj_av$fraction_TS_errors - 6/8)
  grand_av = ddply(subj_av, .(), summarize,
        fraction_TS_errors = mean(fraction_TS_errors, na.rm = T))
  
  gg_otherTS_ACC2 = gg_otherTS_ACC
  gg_otherTS_ACC2$data = dat_l
  gg_otherTS_ACC_value2 = gg_otherTS_ACC_value
  gg_otherTS_ACC_value2$data = dat_l
  gg_otherTS_ACC_alien2 = gg_otherTS_ACC_alien
  gg_otherTS_ACC_alien2$data = dat_l
  gg_prevTS_ACC2 = gg_prevTS_ACC + aes(x = alien_trial_sum, color = factor(ACC_TS, labels = c("Current TS", "Previous TS", "Other TS")), group = ACC_TS) + facet_grid(~ facet) + labs(x = "Trial", color = "")
  gg_prevTS_ACC2$data = dat_l2
  
  gg_otherTS_ACC3 = gg_otherTS_ACC2 + aes(x = alien_trial_sum, color = ACC_TS, shape = factor(current_TS, labels = c("Other TS", "Current TS"))) +
    labs(x = "", color = "", shape = "") +
    facet_grid(~ facet)
  gg_otherTS_ACC3$data = dat_l
  gg_otherTS_ACC4 = gg_otherTS_ACC3 + aes(x = "") + theme(legend.position = "none")

  # Run models
  if (run_regression) {
    others = subset(dat_l, current_TS == F & ACC_TS != "None")
    others$TS_values = factor(others$ACC_TS, levels = c("ACC0", "ACC1", "ACC2"), labels = c(6.25, 5, 3.75))
    others$TS_values = as.numeric(as.character(others$TS_values))
    others$ACC_TS = factor(others$ACC_TS, levels = c("ACC0", "ACC1", "ACC2"), labels = 0:2)
    others = merge(others, by.x = c("sad_alien", "ACC_TS"), all.x = T,
              subset(alien_TS_obj, select = c("sad_alien", "TS", "av_reward")), by.y = c("sad_alien", "TS"),
              suff = c("", "_ACC_TS"))
    # subset(others, select = c("sad_alien", "item_chosen", "av_reward", "av_reward_ACC_TS", "ACC_TS", "TS"), sad_alien == 0 & item_chosen == "umbrella")
    # 
    # ggplot(others, aes(alien_trial_sum, ACC, color = av_reward_ACC_TS, group = av_reward_ACC_TS)) +
    # stat_summary(fun.data = mean_cl_normal, geom = "pointrange") +
    # facet_grid(~ ACC_TS)
    
    intrusions_form = "ACC ~ TS_values + av_reward_ACC_TS + alien_trial_sum + repetition + (TS_values + av_reward_ACC_TS + alien_trial_sum + repetition | subjID)"
    
    glmer_mod_intrusions = glmer(as.formula(intrusions_form),
                      family = binomial,
                      data = others,
                      na.action = na.omit,
                      control = glmerControl(optimizer = 'bobyqa', optCtrl = list(maxfun = 1e6)))
    write.csv(as.data.frame(summary(glmer_mod_intrusions)$coef), paste(plot_dir, "/glmer_mod_intrusions_summary_", phas, ".csv", sep = ""))
  }
  
  if (gg_save) {
    ggsave(paste(plot_dir, "/2gg_otherTS_ACC_", phas, ".png", sep = ""), gg_otherTS_ACC, width = 9, height = 3)
    ggsave(paste(plot_dir, "/2gg_otherTS_ACC_value_", phas, ".png", sep = ""), gg_otherTS_ACC_value, width = 9, height = 6)
    ggsave(paste(plot_dir, "/2gg_otherTS_ACC_alien_", phas, ".png", sep = ""), gg_otherTS_ACC_alien, width = 9, height = 6)
    ggsave(paste(plot_dir, "/2gg_prevTS_ACC_", phas, ".png", sep = ""), gg_prevTS_ACC, width = 9, height = 7)
    
    ggsave(paste(plot_dir, "/2gg_otherTS_ACC2_", phas, ".png", sep = ""), gg_otherTS_ACC2, width = 9, height = 3)
    ggsave(paste(plot_dir, "/2gg_otherTS_ACC3_", phas, ".png", sep = ""), gg_otherTS_ACC3, width = 4, height = 3)
    ggsave(paste(plot_dir, "/2gg_otherTS_ACC4_", phas, ".png", sep = ""), gg_otherTS_ACC4, width = 1, height = 3)
    ggsave(paste(plot_dir, "/2gg_otherTS_ACC_value2_", phas, ".png", sep = ""), gg_otherTS_ACC_value2, width = 9, height = 6)
    ggsave(paste(plot_dir, "/2gg_otherTS_ACC_alien2_", phas, ".png", sep = ""), gg_otherTS_ACC_alien2, width = 9, height = 6)
    ggsave(paste(plot_dir, "/2gg_prevTS_ACC2_", phas, ".png", sep = ""), gg_prevTS_ACC2, width = 4, height = 4)
  }
}
```
```{r Plot learning phase & cloudy season: Learning depends on reward size / value}
for (phas in feed_aliens_phases) {
  
  dat = subset(feed_aliens, phase == phas)
  dat$value = round(dat$av_reward / 2) * 2
  dat$TS_value = as.numeric(as.character(factor(dat$TS, levels = c("0", "1", "2"), labels = c(6.25, 5, 3.75))))
  
  learning_curves_value = ggplot(dat, aes(alien_trial, 100 * ACC, color = value, group = value)) +
    stat_summary(fun.data = mean_cl_normal, geom = "pointrange") +
    geom_hline(yintercept = 100/3, linetype = "dotted") +
    coord_cartesian(y = c(0, 100)) +
    labs(x = "Trial", y = "% correct", color = "Value")
  learning_curves_valuep = learning_curves_value +
    aes(alien_trial_sum, 100 * ACC) +
    stat_summary(fun.data = mean_cl_normal, geom = "line") +
    labs(x = "Trial", y = "% correct", color = "Value") +
    theme(legend.position = "none")
  
  learning_curves_TS = learning_curves_valuep + aes(color = TS_value, group = TS_value)
  learning_curves_TS_aliens = learning_curves_value + facet_grid(sad_alien ~ TS)
  learning_curves_rep = learning_curves_value +
    aes(x = alien_trial_sum, group = floor((alien_trial-1) / length(unique(dat$alien_trial_sum))), color = floor((alien_trial-1) / length(unique(dat$alien_trial_sum)))) +
    labs(x = "Trial", color = "Repetition") +
    # theme(legend.position = "none") +
    facet_grid(~ TS)
  
  learning_value_RTs = learning_curves_TS_aliens + aes(trial_index, rt) + coord_cartesian(ylim = c(0, 2000))
  
  learning_curves_wide = ggplot(dat, aes(alien_trial_sum, 100 * ACC, color = TS, shape = sad_alien)) +
    stat_summary(fun.data = mean_cl_normal, geom = "pointrange") +
    stat_summary(fun.data = mean_cl_normal, geom = "line") +
    labs(x = "Trial", y = "% correct") +
    coord_cartesian(y = c(0, 100)) +
    facet_grid(~ paste("Value", av_reward))

  if (gg_save) {
    ggsave(paste(plot_dir, "/2learning_curves_value_", phas, ".png", sep = ""), learning_curves_valuep, width = 2.3, height = 3)
    ggsave(paste(plot_dir, "/2learning_curves_TS_", phas, ".png", sep = ""), learning_curves_TS, width = 2.3, height = 3)
    ggsave(paste(plot_dir, "/2learning_curves_rep_", phas, ".png", sep = ""), learning_curves_rep, width = 6, height = 3)
    ggsave(paste(plot_dir, "/2learning_curves_TS_aliens_", phas, ".png", sep = ""), learning_curves_TS_aliens, width = 10, height = 10)
    ggsave(paste(plot_dir, "/2learning_value_RTs_", phas, ".png", sep = ""), learning_value_RTs, width = 10, height = 10)
    ggsave(paste(plot_dir, "/2learning_curves_wide_", phas, ".png", sep = ""), learning_curves_wide, width = 15, height = 3)
  }
}
```
```{r Run regressions: Participants infer complete TS rather than individual mappings}
regression_plot = alien_plot + aes(TS, 100 * ACC, fill = sad_alien) + labs(y = "% correct", fill = "Alien")
regression_plot$data = subset(regr_dat, phase == "2CloudySeason")
ggsave(file.path(plot_dir, "3regression_plot.png"), regression_plot, width = 3, height = 3)

sub_dat = subset(regr_dat, phase %in% feed_aliens_phases)
sub_dat[order(sub_dat$subjID, sub_dat$trial),]
ggplot(sub_dat, aes(alien_trial_sum, ACC, color = av_reward, group = av_reward)) +
  stat_summary(fun.data = mean_cl_normal, geom = "pointrange") +
  stat_summary(fun.data = mean_cl_normal, geom = "line") +
  facet_grid(TS ~ phase)
  

if (run_regression) {
  for (phas in feed_aliens_phases) {
    
    trial_value_form = "ACC ~ TS_value + av_reward + alien_trial_sum + repetition + (TS_value + av_reward + alien_trial_sum + repetition | subjID)"
    oneback_self_others_form = "ACC ~ ACC_1back_self * ACC_1back_others + repetition + (ACC_1back_self * ACC_1back_others + repetition | subjID)"
    rew_1back_form = "ACC ~ rew_1back_self + repetition + (rew_1back_self + repetition | subjID)"
    
    glmer_mod_trial_value = glmer(as.formula(trial_value_form),
                      family = binomial,
                      data = subset(regr_dat, phase == phas),
                      na.action = na.omit,
                      control = glmerControl(optimizer = 'bobyqa', optCtrl = list(maxfun = 1e6)))
    write.csv(as.data.frame(summary(glmer_mod_trial_value)$coef), paste(plot_dir, "/glmer_trial_value_summary_", phas, ".csv", sep = ""))
    
    glmer_mod_1back_self_others = update(glmer_mod_trial_value, formula = as.formula(oneback_self_others_form))
    write.csv(as.data.frame(summary(glmer_mod_1back_self_others)$coef), paste(plot_dir, "/glmer_oneback_self_others_summary_", phas, ".csv", sep = ""))
    
    glmer_mod_rew_1back = update(glmer_mod_trial_value, formula = as.formula(rew_1back_form))
    write.csv(as.data.frame(summary(glmer_mod_rew_1back)$coef), paste(plot_dir, "/glmer_rew_1back_summary_", phas, ".csv", sep = ""))
  }
}
```
```{r}
# # Get subjects' choices in the rainbow season
# rainbow_aliens = ddply(subset(feed_aliens, phase == "5RainbowSeason" & !is.na(key)),
#                        .(subjID, sad_alien, TS, item_chosen),
#                        summarize,
#                        times_chosen = length(item_chosen))  # in how many trials subject chose each item for each alien
# missed_trials = ddply(subset(feed_aliens, phase == "5RainbowSeason" & is.na(key)),
#                        .(subjID, sad_alien, item_chosen),
#                        summarize,
#                        times_chosen = length(item_chosen))  # number of missed trials
# missed_trials$TS = "Missed"
# rainbow_aliens = rbind(rainbow_aliens, missed_trials)  # , overlapping_plant, overlapping_bed
# rainbow_aliens$TS = as.character(rainbow_aliens$TS)
# rainbow_aliens = merge(subset(rainbow_aliens), correct_values,  # what's the TS that the choice corresponds to?
#       by = c("subjID", "sad_alien", "item_chosen"),
#       all.x = T)
# 
# rainbow_aliens$TS = rainbow_aliens$TS.y
# rainbow_aliens$TS = as.character(rainbow_aliens$TS)
# rainbow_aliens$TS[rainbow_aliens$TS.x != "rainbow"] = rainbow_aliens$TS.x[rainbow_aliens$TS.x != "rainbow"]
# rainbow_aliens$TS.x = rainbow_aliens$TS.y = NULL
# rainbow_aliens$TS[is.na(rainbow_aliens$TS)] = "No TS"
# 
# # Create data of randomly acting subjects' choices (as a baselien to see if actual participants are closer to the TS, and to which ones)
# # TD
# 
# # Categorize participants' strategies: count of choices "within" each TS divided by total number of choices
# rainbow_sum = data.frame()
# for (TSi in unique(rainbow_aliens$TS)) {
#   rainbow_TS = ddply(rainbow_aliens, .(subjID, TS == TSi), summarize,
#                       times_chosen_others = sum(times_chosen))
#   rainbow_TS_w = reshape(rainbow_TS, direction = "wide", timevar = "TS == TSi", idvar = "subjID")
#   rainbow_TS_w[TSi] = with(rainbow_TS_w, times_chosen_others.TRUE / 12)  # add column with fraction chosen / possible
#   rainbow_TS_w$times_chosen_others.FALSE = rainbow_TS_w$times_chosen_others.TRUE = NULL
#   if (nrow(rainbow_sum) > 0) {
#     rainbow_sum = merge(rainbow_sum, rainbow_TS_w, all = T)
#   } else {
#     rainbow_sum = rainbow_TS_w
#   }
# }
# 
# rainbow_sum = rainbow_sum[order(apply(rainbow_sum["0"], 1, max, na.rm = T)),]
# rainbow_sum$orderedSubj = nrow(rainbow_sum):1
# rainbow_sum = rainbow_sum[order(apply(rainbow_sum[c("Missed", "No TS", "0", "1", "2")], 1, sum, na.rm = T)),]  # "Plant", "Bed", 
# rainbow_sum$orderedSubj2 = nrow(rainbow_sum):1
# 
# rainbow_sum_l = melt(rainbow_sum, id.vars = c("subjID", "orderedSubj", "orderedSubj2"), variable.name = "TS", value.name = "Ratio")
# rainbow_sum_l$Ratio[is.na(rainbow_sum_l$Ratio)] = 0
# rainbow_sum_l$TS = factor(rainbow_sum_l$TS, levels = c("Missed", "No TS", "2", "1", "0"), labels = c("Missed", "No TS", "TS2", "TS1", "TS0"))
# 
# overlapping_choices = ddply(subset(feed_aliens, phase == "5RainbowSeason" &
#                                      ((sad_alien == 0 & item_chosen == "plant") |
#                                       (sad_alien == 3 & item_chosen == "bed"))),
#                        .(subjID, sad_alien, item_chosen),
#                        summarize,
#                        times_chosen = length(item_chosen))
# add = rbind(expand.grid(subjID = unique(overlapping_choices$subjID), sad_alien = 0, item_chosen = "plant"),
#             expand.grid(subjID = unique(overlapping_choices$subjID), sad_alien = 3, item_chosen = "bed"))
# overlapping_choices = merge(overlapping_choices, add, all = T)  # add 0 choices
# overlapping_choices$times_chosen[is.na(overlapping_choices$times_chosen)] = 0
```
```{r Create Rainbow season data}
# Create data.frame that shows accuracy according to each of the 3 TS, none, and missed trials
all_ACCs = expand.grid(sad_alien = unique(feed_aliens$sad_alien), item_chosen = unique(feed_aliens$item_chosen))
correct_ones = ddply(subset(all_files, ACC == 1 & season %in% c("cold", "hot", "rainy")),
                    .(TS, sad_alien), summarize,
                    item_chosen = item_chosen[1])
correct_ones$ACC = 1
correct_ones = reshape(correct_ones, direction = "wide", timevar = "TS", idvar = c("sad_alien", "item_chosen")) #, "value"

all_ACCs = merge(all_ACCs, correct_ones, all.x = T)
all_ACCs$ACC.Missed = ifelse(all_ACCs$item_chosen == "NaN", 1, 0)
all_ACCs$ACC.None = with(all_ACCs, (is.na(ACC.0)) * (is.na(ACC.1)) * (is.na(ACC.2)) * (1 - ACC.Missed))
all_ACCs$ACC.02 = with(all_ACCs, ACC.0 * ACC.2)
all_ACCs$ACC.12 = with(all_ACCs, ACC.1 * ACC.2)
all_ACCs$ACC.only0 = with(all_ACCs, ACC.0 * (is.na(ACC.02)))
all_ACCs$ACC.only1 = with(all_ACCs, ACC.1 * (is.na(ACC.12)))
all_ACCs$ACC.only2 = with(all_ACCs, ACC.2 * (is.na(ACC.12)) * (is.na(ACC.02)))

rainbow_aliens = merge(subset(feed_aliens, phase == "5RainbowSeason", select = c("subjID", "sad_alien", "item_chosen")),
                       all_ACCs)
rainbow_aliens[order(rainbow_aliens$subjID, rainbow_aliens$sad_alien),]

cloudy_aliens = merge(subset(feed_aliens, phase == "2CloudySeason" & trial == 1, select = c("subjID", "sad_alien", "item_chosen")),
                       all_ACCs)
cloudy_aliens[order(cloudy_aliens$subjID, cloudy_aliens$sad_alien),]

cloudy_sum = ddply(cloudy_aliens, .(subjID), summarize,
      TS0 = sum(ACC.only0, na.rm = T),
      TS1 = sum(ACC.only1, na.rm = T),
      TS2 = sum(ACC.only2, na.rm = T),
      TS0and2 = sum(ACC.02, na.rm = T),
      TS1and2 = sum(ACC.12, na.rm = T),
      Missed = sum(ACC.Missed, na.rm = T),
      None = sum(ACC.None, na.rm = T))
```
```{r Cloudy season}

# Model: frac_chosen ~ TS_value + alien_values + TS_ACC
cloudy_sum_l = melt(cloudy_sum, id.vars = c("subjID"), variable.name = "TS", value.name = "times_chosen")
cloudy_sum_l$TS = factor(cloudy_sum_l$TS, levels = c("TS0", "TS0and2", "TS1", "TS1and2", "TS2", "None", "Missed"))
cloudy_sum_l$frac_chosen = cloudy_sum_l$times_chosen
cloudy_sum_l$frac_chosen[cloudy_sum_l$TS %in% c("TS0", "TS1")] = cloudy_sum_l$times_chosen[cloudy_sum_l$TS %in% c("TS0", "TS1")] / 3
cloudy_sum_l$frac_chosen[cloudy_sum_l$TS %in% c("None", "TS2")] = cloudy_sum_l$times_chosen[cloudy_sum_l$TS %in% c("None", "TS2")] / 2
cloudy_sum_l$frac_chosen[cloudy_sum_l$TS == "Missed"] = NA

ggplot(cloudy_sum_l, aes(TS, frac_chosen)) +
  stat_summary(fun.data="mean_cl_normal", geom="pointrange", position="dodge")

cloudy_sum_l = subset(cloudy_sum_l, TS %in% c("TS0", "TS1", "TS2"))
cloudy_sum_l$TS = gsub("TS", "", cloudy_sum_l$TS)
acc_dat = ddply(subset(feed_aliens, phase == "Refresher3"), .(subjID, TS), summarize,
                TS_ACC = mean(ACC, na.rm = T))
cloudy_sum_l = merge(cloudy_sum_l, all.x=T, acc_dat, by=c("subjID", "TS"))
# val_dat = ddply(subset(feed_aliens, phase == "Refresher3" & ACC == 1), .(subjID, TS), summarize,
#                 TS_value = mean(reward, na.rm = T))
# rainbow_sum_l = merge(rainbow_sum_l, all.x=T, val_dat, by=c("subjID", "TS"))
cloudy_sum_l$alien_values = NA
cloudy_sum_l$alien_values[cloudy_sum_l$TS == 0] = mean(c(6, 5, 4))
cloudy_sum_l$alien_values[cloudy_sum_l$TS == 1] = mean(c(3, 7, 8))
cloudy_sum_l$alien_values[cloudy_sum_l$TS == 2] = mean(c(3, 3))
cloudy_sum_l$TS_value = NA
cloudy_sum_l$TS_value[cloudy_sum_l$TS == 0] = 6.25
cloudy_sum_l$TS_value[cloudy_sum_l$TS == 1] = 5
cloudy_sum_l$TS_value[cloudy_sum_l$TS == 2] = 3.75
cloudy_sum_l$TS = factor(cloudy_sum_l$TS)
contrasts(cloudy_sum_l$TS) = -contr.poly(3)

mod = lm(frac_chosen ~ TS_value + TS_ACC + alien_values,
         cloudy_sum_l,
         na.action=na.omit)
summary(mod)

TS_choices = 6 - cloudy_sum$Missed - cloudy_sum$None
Valid_choices = 6 - cloudy_sum$Missed
mean(TS_choices)
mean(Valid_choices)
mean(TS_choices / Valid_choices)
t.test(TS_choices - 10 / 12 * Valid_choices)

None_choices = cloudy_sum$None
mean(None_choices / Valid_choices)
t.test(None_choices - 2 / 12 * Valid_choices)

mean(cloudy_sum$TS0)
mean(cloudy_sum$TS0 / Valid_choices)
t.test(cloudy_sum$TS0 - 3 / 12 * Valid_choices)
mean(cloudy_sum$TS1)
mean(cloudy_sum$TS1 / Valid_choices)
t.test(cloudy_sum$TS1 - 3 / 12 * Valid_choices)
t.test(cloudy_sum$TS0 - cloudy_sum$TS1)
mean(cloudy_sum$TS2)
mean(cloudy_sum$TS2 / Valid_choices)
t.test(cloudy_sum$TS2 - 2 / 12 * Valid_choices)
mean(cloudy_sum$None)
mean(cloudy_sum$None / Valid_choices)
t.test(cloudy_sum$None - 2 / 12 * Valid_choices)
Double_TS_choices = cloudy_sum$TS0and2 + cloudy_sum$TS1and2
mean(Double_TS_choices)
mean(Double_TS_choices / Valid_choices)
t.test(Double_TS_choices - 2 / 12 * Valid_choices)
```
```{r Rainbow season}

rainbow_sum = ddply(rainbow_aliens, .(subjID), summarize,
      TS0 = sum(ACC.only0, na.rm = T),
      TS1 = sum(ACC.only1, na.rm = T),
      TS2 = sum(ACC.only2, na.rm = T),
      TS0and2 = sum(ACC.02, na.rm = T),
      TS1and2 = sum(ACC.12, na.rm = T),
      Missed = sum(ACC.Missed, na.rm = T),
      None = sum(ACC.None, na.rm = T))
ddply(rainbow_sum, .(), summarize,
      TS0 = mean(TS0, na.rm = T),
      TS1 = mean(TS1, na.rm = T),
      TS2 = mean(TS2, na.rm = T),
      TS0and2 = mean(TS0and2, na.rm = T),
      TS1and2 = mean(TS1and2, na.rm = T),
      Missed = mean(Missed, na.rm = T),
      None = mean(None, na.rm = T))
# rainbow_sum$sum = apply(subset(rainbow_sum, select = -subjID), 1, sum)  # checking that they sum up to 12
rainbow_sum = rainbow_sum[order(rainbow_sum$TS0 + rainbow_sum$TS0and2),]
rainbow_sum$orderedSubj = nrow(rainbow_sum):1
rainbow_sum

# Model: frac_chosen ~ TS_value + alien_values + TS_ACC
rainbow_sum_l = melt(rainbow_sum, id.vars = c("subjID", "orderedSubj"), variable.name = "TS", value.name = "times_chosen")
rainbow_sum_l$TS = factor(rainbow_sum_l$TS, levels = c("TS0", "TS0and2", "TS1", "TS1and2", "TS2", "None", "Missed"))
rainbow_sum_l$frac_chosen = rainbow_sum_l$times_chosen
rainbow_sum_l$frac_chosen[rainbow_sum_l$TS %in% c("TS0", "TS1")] = rainbow_sum_l$times_chosen[rainbow_sum_l$TS %in% c("TS0", "TS1")] / 3
rainbow_sum_l$frac_chosen[rainbow_sum_l$TS %in% c("None", "TS2")] = rainbow_sum_l$times_chosen[rainbow_sum_l$TS %in% c("None", "TS2")] / 2
rainbow_sum_l$frac_chosen[rainbow_sum_l$TS == "Missed"] = NA

ggplot(rainbow_sum_l, aes(TS, frac_chosen)) +
  stat_summary(fun.data="mean_cl_normal", geom="pointrange", position="dodge")

rainbow_sum_l = subset(rainbow_sum_l, TS%in%c("TS0", "TS1", "TS2"))
rainbow_sum_l$TS = gsub("TS", "", rainbow_sum_l$TS)
acc_dat = ddply(subset(feed_aliens, phase == "Refresher3"), .(subjID, TS), summarize,
                TS_ACC = mean(ACC, na.rm = T))
rainbow_sum_l = merge(rainbow_sum_l, all.x=T, acc_dat, by=c("subjID", "TS"))
# val_dat = ddply(subset(feed_aliens, phase == "Refresher3" & ACC == 1), .(subjID, TS), summarize,
#                 TS_value = mean(reward, na.rm = T))
# rainbow_sum_l = merge(rainbow_sum_l, all.x=T, val_dat, by=c("subjID", "TS"))
rainbow_sum_l$alien_values = NA
rainbow_sum_l$alien_values[rainbow_sum_l$TS == 0] = mean(c(6, 5, 4))
rainbow_sum_l$alien_values[rainbow_sum_l$TS == 1] = mean(c(3, 7, 8))
rainbow_sum_l$alien_values[rainbow_sum_l$TS == 2] = mean(c(3, 3))
rainbow_sum_l$TS_value = NA
rainbow_sum_l$TS_value[rainbow_sum_l$TS == 0] = 6.25
rainbow_sum_l$TS_value[rainbow_sum_l$TS == 1] = 5
rainbow_sum_l$TS_value[rainbow_sum_l$TS == 2] = 3.75
rainbow_sum_l$TS = factor(rainbow_sum_l$TS)
contrasts(rainbow_sum_l$TS) = -contr.poly(3)

mod = lm(frac_chosen ~ TS_value + TS_ACC + alien_values,
         rainbow_sum_l,
         na.action=na.omit)
summary(mod)

# Were more TS-related items selected than expected based on chance?
TS_choices = 12 - rainbow_sum$Missed - rainbow_sum$None
Valid_choices = 12 - rainbow_sum$Missed
mean(TS_choices)
mean(Valid_choices)
mean(TS_choices / Valid_choices)
t.test(TS_choices - 10 / 12 * Valid_choices)

None_choices = rainbow_sum$None
mean(None_choices / Valid_choices)
t.test(None_choices - 2 / 12 * Valid_choices)

mean(rainbow_sum$TS0)
mean(rainbow_sum$TS0 / Valid_choices)
t.test(rainbow_sum$TS0 - 3 / 12 * Valid_choices)
mean(rainbow_sum$TS1)
mean(rainbow_sum$TS1 / Valid_choices)
t.test(rainbow_sum$TS1 - 3 / 12 * Valid_choices)
t.test(rainbow_sum$TS0 - rainbow_sum$TS1)
mean(rainbow_sum$TS2)
mean(rainbow_sum$TS2 / Valid_choices)
t.test(rainbow_sum$TS2 - 2 / 12 * Valid_choices)
mean(rainbow_sum$None)
mean(rainbow_sum$None / Valid_choices)
t.test(rainbow_sum$None - 2 / 12 * Valid_choices)
Double_TS_choices = rainbow_sum$TS0and2 + rainbow_sum$TS1and2
mean(Double_TS_choices)
mean(Double_TS_choices / Valid_choices)
t.test(Double_TS_choices - 2 / 12 * Valid_choices)
```
```{r}
# Create value dat
# values = ddply(subset(all_files, ACC == 1 & season %in% c("cold", "hot", "rainy")),
#                     .(TS, sad_alien), summarize,
#                     value = round(mean(reward, na.rm = T)),
#                     item_chosen = item_chosen[1])
# values = merge(values, rainbow_aliens)
# values_sum = ddply(values, .(subjID, value), summarize,
#       TS0 = sum(ACC.0, na.rm = T),
#       TS1 = sum(ACC.1, na.rm = T),
#       TS2 = sum(ACC.2, na.rm = T))
# 
# values_sum_l = melt(values_sum, id.vars = c("subjID", "value"), variable.name = "TS", value.name = "times_chosen")
```

```{r Plot rainbow season}
lines = c(1, 2, 3)
gg_rainbow_strategy_frac = ggplot(rainbow_sum_l, aes(TS, frac_chosen, color = TS)) +
  geom_hline(yintercept = 1, linetype = "dotted") +
  stat_summary(fun.data = mean_cl_boot, geom = "pointrange") +
  labs(x = "", y = "Fraction of chance-expected TS choices", fill = "") +
  theme(legend.position = "none")

gg_rainbow_strategy = ggplot(rainbow_sum_l, aes(TS, times_chosen, fill = TS)) + 
  geom_hline(yintercept = lines, linetype = "dotted") +
  geom_point(position = "jitter", alpha = 0.3) +
  stat_summary(fun.data = mean_cl_boot, geom = "bar") +
  stat_summary(fun.data = mean_cl_boot, geom = "pointrange", color = "black") +
  geom_point(position = "jitter", alpha = 0.3) +
  labs(x = "", y = "# TS choices", fill = "") +
  annotate("text", x = rep(7.7, 3), y = lines, label = lines) +
  theme(legend.position = "none")

gg_subj_strategy = ggplot(rainbow_sum_l, aes(orderedSubj, times_chosen / 12, fill = TS)) +
  geom_bar(stat = "identity") +
  labs(x = "", y = "Fraction TS choices", fill = "") +
  geom_hline(yintercept = c(2/12, 4/12, 5/12, 8/12, 9/12), colors = c("purple", "blue", "turkois", "green", "orange", "red"), linetype = "dotted") +
  theme(axis.text.x = element_blank())

gg_strategy_hist = ggplot(subset(rainbow_sum_l, TS %in% c("TS0", "TS1", "TS2", "None")), aes(times_chosen, fill = TS)) +
  geom_histogram(stat = "density", position = "identity", alpha = 0.5) +
  labs(x = "# TS choices", fill = "")

# gg_rainbow_values = ggplot(subset(values_sum_l),  #, round(value) > 2 TD: TAKE OUT FOR NEW DATA!!!
#        aes(value, times_chosen, color = TS)) +
#   stat_summary(fun.data = mean_cl_normal, geom = "pointrange") +
#   labs(x = "Value", y = "Fraction chosen", color = "TS")

if (gg_save) {
  ggsave(file.path(plot_dir, "5gg_rainbow_strategy.png"), gg_rainbow_strategy, width = 5, height = 3)
  ggsave(file.path(plot_dir, "5gg_rainbow_strategy_frac.png"), gg_rainbow_strategy_frac, width = 5, height = 3)
  # ggsave(file.path(plot_dir, "5gg_rainbow_values.png"), gg_rainbow_values, width = 4, height = 3)
  ggsave(file.path(plot_dir, "5gg_subj_strategy.png"), gg_subj_strategy, width = 5, height = 3)
  # ggsave(file.path(plot_dir, "5gg_subj_strategy2.png"), gg_subj_strategy2, width = 5, height = 3)
  ggsave(file.path(plot_dir, "5gg_strategy_hist.png"), gg_strategy_hist, width = 5, height = 3)
}
```

```{r Rainbow season - choice descriptives}
# Combine OPTIMAL CHOICES with subject's choices in the rainbow season
rainbow_aliens$TS = "rainbow"
comb_dat = merge(correct_values,
                 rainbow_aliens,
                 by = c("subjID", "sad_alien", "TS", "item_chosen", "av_reward"), all = T)
comb_dat

# Plot OPTIMAL CHOICES in every season together with subject's choices in the rainbow season
comb_dat_sum = ddply(comb_dat,
                     .(sad_alien, item_chosen, TS), summarize,
                     av_reward = mean(av_reward, na.rm = T))

# Standardize TS values and rainbow choices to bring them into the same scale for plotting
x = comb_dat_sum$av_reward[comb_dat_sum$TS != "rainbow"]
mu = mean(x, na.rm = T)
sd = sd(x, na.rm = T)
comb_dat_sum$av_reward[comb_dat_sum$TS != "rainbow"] = (x - mu) / sd

x = comb_dat_sum$av_reward[comb_dat_sum$TS == "rainbow"]
mu = mean(x, na.rm = T)
sd = sd(x, na.rm = T)
comb_dat_sum$av_reward[comb_dat_sum$TS == "rainbow"] = (x - mu) / sd

gg_rainbow_choice = ggplot(rainbow_aliens, aes(sad_alien, item_chosen, color = TS)) +#, size = av_reward
  geom_point() +
  theme(legend.position = "none") +
  labs(x = "Alien", y = "", color = "") +
  facet_grid( ~ paste("TS", TS))

gg_rainbow_choice_subj = gg_rainbow_choice
gg_rainbow_choice_subj$data = rainbow_aliens
gg_rainbow_choice_subj = gg_rainbow_choice_subj +
  facet_wrap(~ paste("Subj", subjID))

if (gg_save) {
  ggsave(file.path(plot_dir, "5gg_rainbow_choice.png"), gg_rainbow_choice, width = 7, height = 2)
  ggsave(file.path(plot_dir, "5gg_rainbow_choice_subj2.png"), gg_rainbow_choice_subj, width = 15, height = 15)
}
```
```{r Start button}
```