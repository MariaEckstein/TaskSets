---
title: "TaskSets"
author: "Maria Eckstein"
date: "July 19, 2017"
output: html_document
---

```{r Set parameters, load packages, etc.}

library("ggplot2"); library("plyr"); library("lme4")
theme_set(theme_bw())

n_aliens = 4
n_trials_initial = 13
n_trials_cloudy = 10
data_dir = "C:/Users/maria/MEGAsync/Berkeley/TaskSets/Data/"
plot_dir = file.path(data_dir, "plots")
if (!dir.exists(plot_dir)) {
  dir.create(plot_dir)
}
perf_criterion = 0.5  # participants who perform worse that that at the end of training (last 4 trials per alien) are excluded
gg_save = T
run_regression = F
```
```{r Read in data}
filenames = list.files(data_dir, pattern = "*.csv")
all_files = data.frame()
for (filename in filenames) {
  subj_file = read.csv(file = file.path(data_dir, filename), header = T, na.strings = c("", "NA", "-1"))
  subj_file$subjID = strsplit(substr(as.character(subj_file$responses), 8, 10), "[^0-9]")[[1]][[1]]
  subj_file = subset(subj_file, select = -c(responses, internal_node_id, view_history))
  
  # Add trial column: counter within blocks
  subj_file$trial = NA
  for (row in 2:nrow(subj_file)) {
    if (is.na(subj_file$season[row])) {
      trial = NA
    } else {
      if (is.na(subj_file$season[row-1])) {
        trial = 1
      } else {
        trial = trial + 1
      }
    }
    subj_file$trial[row] = trial
  }
  
  subj_file$alien_trial = NA
  alien_season_counter = data.frame(training = rep(0, n_aliens),
                                    hot = rep(0, n_aliens), cold = rep(0, n_aliens), rainy = rep(0, n_aliens),
                                    hot_cloudy = rep(0, n_aliens), cold_cloudy = rep(0, n_aliens), rainy_cloudy = rep(0, n_aliens),
                                    rainbow = rep(0, n_aliens))
  
  for (row in 1:nrow(subj_file)) {
    sad_alien = subj_file$sad_alien[row] + 1
    if (!is.na(sad_alien)) {
      season = as.character(subj_file$season[row])
      alien_season_counter[sad_alien, season] = alien_season_counter[sad_alien, season] + 1
      count = alien_season_counter[sad_alien, season]
      subj_file$alien_trial[row] = count
    }
  }
  
  all_files = rbind(all_files, subj_file)
}

all_files$subjID = as.numeric(as.character(all_files$subjID))
all_files$sad_alien = factor(all_files$sad_alien)
all_files$ACC = ifelse(all_files$correct == "true", 1, 0)

all_files$item_left = as.character(all_files$item_left)
all_files$item_right = as.character(all_files$item_right)
all_files$item_center = as.character(all_files$item_center)
for (row in 1:nrow(all_files)) {
  left_item = as.character(all_files$item_left[row])
  left_item_name = ifelse(is.na(left_item), NA, strsplit(strsplit(left_item, "id=\'")[[1]][2], "-button")[[1]])
  all_files$item_left[row] = left_item_name
  
  center_item = as.character(all_files$item_center[row])
  center_item_name = ifelse(is.na(center_item), NA, strsplit(strsplit(center_item, "id=\'")[[1]][2], "-button")[[1]])
  all_files$item_center[row] = center_item_name
  
  right_item = as.character(all_files$item_right[row])
  right_item_name = ifelse(is.na(right_item), NA, strsplit(strsplit(right_item, "id=\'")[[1]][2], "-button")[[1]])
  all_files$item_right[row] = right_item_name
}

all_files$time_elapsed = all_files$points0 = all_files$points1 = all_files$points2 = NULL
all_files$TS = as.character(all_files$TS)
all_files$TS[is.na(all_files$TS)] = as.character(all_files$season[is.na(all_files$TS)])  # if column TS is NA, replace it with season column
all_files$TS = factor(all_files$TS)

all_files
summary(all_files)
```
```{r Clean data and create summary dataframe}

# Exclude subjects who don't reach criterion in training block
criterion_dat = subset(all_files, season == "training" & alien_trial %in% 8:10)
perf_dat = ddply(criterion_dat, .(subjID), summarize,
                 ACC = mean(ACC, na.rm = T))
perf_dat$below_criterion = perf_dat$ACC < perf_criterion
(chance_performers = subset(perf_dat, below_criterion == T))
all_files = subset(all_files, !subjID %in% chance_performers$subjID)
```
```{r Calculate learned values for aliens, seasons, items}
learnt_values = subset(all_files, phase %in% c("1InitialLearning", "Refresher2", "Refresher3") & item_chosen != "NaN")
alien_values = ddply(learnt_values, .(subjID, phase, sad_alien), summarize,
                     av_reward = mean(reward, na.rm = T))
alien_values$selected = paste("alien", as.numeric(as.character(alien_values$sad_alien))+1, sep = "")
alien_values$assess = "Alien"
alien_values$sad_alien = NULL

TS_values = ddply(learnt_values, .(subjID, phase, TS), summarize,
                      av_reward = mean(reward, na.rm = T))
TS_values$selected = paste("TS", TS_values$TS, sep = "")
TS_values$assess = "TS"
TS_values$TS = NULL

item_values = ddply(learnt_values, .(subjID, phase, item_chosen), summarize,
                    av_reward = mean(reward, na.rm = T))
item_values$selected = item_values$item_chosen
item_values$assess = "Item"
item_values$item_chosen = NULL

alien_TS_values = ddply(learnt_values, .(subjID, phase, TS, sad_alien), summarize,
                        av_reward = mean(reward, na.rm = T))
alien_TS_values$selected = with(alien_TS_values, paste("alien", as.numeric(as.character(sad_alien))+1, TS, sep = ""))
alien_TS_values$assess = "AlienSameTS"

all_values = rbind(alien_values, TS_values, item_values, subset(alien_TS_values, select = -c(TS, sad_alien)))
all_values
```
```{r Calculate final performance}
dat = subset(all_files, phase == "Refresher2")
alien_perf = ddply(dat, .(subjID, sad_alien), summarize,
                   av_ACC = mean(ACC, na.rm = T))
alien_perf$selected = paste("alien", as.numeric(as.character(alien_perf$sad_alien))+1, sep = "")
alien_perf$assess = "Alien"
alien_perf$sad_alien = NULL

TS_perf = ddply(dat, .(subjID, TS), summarize,
                av_ACC = mean(ACC, na.rm = T))
TS_perf$selected = paste("TS", TS_perf$TS, sep = "")
TS_perf$assess = "TS"
TS_perf$TS = NULL

item_perf = ddply(dat, .(subjID, item_chosen), summarize,
                  av_ACC = mean(ACC, na.rm = T))
item_perf$selected = item_perf$item_chosen
item_perf$assess = "Item"
item_perf$item_chosen = NULL

alien_TS_perf = ddply(dat, .(subjID, TS, sad_alien), summarize,
                      av_ACC = mean(ACC, na.rm = T))
alien_TS_perf$selected = with(alien_TS_perf, paste("alien", as.numeric(as.character(sad_alien))+1, TS, sep = ""))
alien_TS_perf$assess = "AlienSameTS"

all_perf = rbind(alien_perf, TS_perf, item_perf, subset(alien_TS_perf, select = -c(TS, sad_alien)))
all_perf$phase = "Refresher2"

all_values_perf = merge(all_values, all_perf, all = T)
all_values_perf
```
```{r Create pick_aliens data}

# all_values: what are the experiences values of each alien, item, TS, and each alien-TS combo?
# all_values = rbind(subset(alien_TS_values, phase == "Refresher2", select = c("subjID", "assess", "selected", "av_reward")),
#                    subset(alien_values, phase == "Refresher2", select = c("subjID", "assess", "selected", "av_reward")),
#                    subset(TS_values, phase == "Refresher2", select = c("subjID", "assess", "selected", "av_reward")),
#                    subset(item_values, phase == "Refresher2", select = c("subjID", "assess", "selected", "av_reward")))

# all_perf: how well do participants know each mapping going into the competition phase?

# season_TS: which season corresponds to each TS for each subject?
season_TS = ddply(subset(all_files, trial_type == "feed-aliens" & season %in% c("hot", "rainy", "cold")),
                  .(subjID, TS, season), summarize,
                  TS = TS[1])

# pick_aliens: Which choices did subjects make in phase 3?
pick_aliens = subset(all_files, trial_type == "pick-aliens", select = c("subjID", "trial_index", "item_left", "item_right", "item_chosen", "assess"))
### Remove "-button"
pick_aliens$item_chosen = as.character(pick_aliens$item_chosen)
for (row in 1:nrow(pick_aliens)) {
  chosen_item = as.character(pick_aliens$item_chosen[row])
  chosen_item_name = ifelse(is.na(chosen_item), NA, strsplit(strsplit(chosen_item, "#")[[1]][2], "-button")[[1]])
  pick_aliens$item_chosen[row] = chosen_item_name
}
pick_aliens$item_chosen[pick_aliens$item_chosen == "xyz"] = NA
### Replace "hot", "cold", "rainy" with participants' corresponding TS 
for (subj in levels(factor(all_files$subjID))) {
  for (seas in c("hot", "cold", "rainy")) {
    sub = subset(season_TS, subjID == subj & season == seas)$TS
    pick_aliens$item_right = gsub(seas, sub, pick_aliens$item_right)
    pick_aliens$item_left = gsub(seas, sub, pick_aliens$item_left)
    pick_aliens$item_chosen = gsub(seas, sub, pick_aliens$item_chosen)
  }
}
pick_aliens$assess = as.character(pick_aliens$assess)
pick_aliens$assess = gsub("season", "TS", pick_aliens$assess)
pick_aliens$item_unchosen = ifelse(pick_aliens$item_chosen == pick_aliens$item_right, pick_aliens$item_left, pick_aliens$item_right)
pick_aliens$item_left = pick_aliens$item_right = NULL
### Rename "0", "1", "2" to "TS0", "TS1", "TS2"
# pick_aliens$item_chosen = as.character(pick_aliens$item_chosen)
pick_aliens$item_chosen[pick_aliens$assess == "TS" & !is.na(pick_aliens$item_chosen)] = paste("TS", pick_aliens$item_chosen[pick_aliens$assess == "TS" & !is.na(pick_aliens$item_chosen)], sep = "")
pick_aliens$item_unchosen = as.character(pick_aliens$item_unchosen)
pick_aliens$item_unchosen[pick_aliens$assess == "TS"] = paste("TS", pick_aliens$item_unchosen[pick_aliens$assess == "TS"], sep = "")
### Add columns for the values of each trial's chosen and unchosen items
for (col in c("unchosen", "chosen")) {
  pick_aliens = merge(pick_aliens, all.x = T,
                      subset(all_values_perf, phase == "Refresher2", select = c("subjID", "selected", "av_reward", "av_ACC")),
                      by.x = c("subjID", paste("item_", col, sep = "")), by.y = c("subjID", "selected"))
  colnames(pick_aliens)[colnames(pick_aliens) %in% "av_reward"] = paste("value_", col, sep = "")
  colnames(pick_aliens)[colnames(pick_aliens) %in% "av_ACC"] = paste("ACC_", col, sep = "")
}
pick_aliens = pick_aliens[order(pick_aliens$subjID, pick_aliens$assess, pick_aliens$item_chosen, pick_aliens$item_unchosen),]

pick_aliens_sum = ddply(subset(pick_aliens, !is.na(assess)),
                        .(subjID, assess), summarize,
                        value_diff = mean(value_chosen - value_unchosen, na.rm = T),
                        ACC_diff = mean(ACC_chosen - ACC_unchosen, na.rm = T))
```
```{r Plot competition phase: Participants have no idea what they are doing}
gg_pick_aliens_value = ggplot(pick_aliens_sum, aes(assess, value_diff, color = subjID)) +
  stat_summary(fun.y = "mean", geom = "bar") +
  stat_summary(fun.data = "mean_se", geom = "pointrange") +
  labs(x = "", y = "Value chosen minus unchosen", color = "Participant") +
  geom_point(position = "jitter", alpha = 0.3)
gg_pick_aliens_ACC = gg_pick_aliens_value +
  aes(assess, ACC_diff) +
  labs(x = "", y = "ACC chosen minus unchosen")

gg_pick_aliens_value_subj = ggplot(subset(pick_aliens), aes(trial_index, value_chosen - value_unchosen, color = assess)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  labs(x = "Trial", y = "Value chosen minus unchosen", color = "") +
  facet_wrap(~ subjID)
gg_pick_aliens_ACC_subj = gg_pick_aliens_value_subj +
  aes(trial_index, ACC_chosen - ACC_unchosen, color = assess) +
  labs(x = "Trial", y = "ACC chosen minus unchosen")

cute_dat_chosen = ddply(subset(pick_aliens, !item_chosen %in% c("xyz", "TSxyz")), .(assess, item_chosen), summarize,
                 count_chosen = length(item_chosen))
cute_dat_unchosen = ddply(subset(pick_aliens, !item_chosen %in% c("xyz", "TSxyz")), .(assess, item_unchosen), summarize,
                 count_unchosen = length(item_unchosen))
cute_dat = merge(cute_dat_chosen, cute_dat_unchosen,
                 by.x = c("assess", "item_chosen"),
                 by.y = c("assess", "item_unchosen"))

gg_pick_aliens_raw_ch = ggplot(cute_dat, aes(assess, count_chosen / length(unique(pick_aliens$subjID)), color = item_chosen)) +
  geom_point(position = position_dodge(width = 0.9)) +
  labs(x = "", y = "Chosen count", color = "")
gg_pick_aliens_raw_unch = gg_pick_aliens_raw_ch +
  aes(y = count_unchosen / length(unique(pick_aliens$subjID))) +
  labs(y = "Unchosen count")
gg_pick_aliens_raw_diff = gg_pick_aliens_raw_ch +
  aes(y = (count_chosen - count_unchosen) / length(unique(pick_aliens$subjID))) +
  geom_hline(yintercept = 0) +
  labs(y = "Chosen - unchosen")

if (gg_save) {
  ggsave(file.path(plot_dir, "4gg_pick_aliens_value.png"), gg_pick_aliens_value, width = 5, height = 3)
  ggsave(file.path(plot_dir, "4gg_pick_aliens_ACC.png"), gg_pick_aliens_ACC, width = 5, height = 3)
  ggsave(file.path(plot_dir, "4gg_pick_aliens_value_subj.png"), gg_pick_aliens_value_subj, width = 15, height = 15)
  ggsave(file.path(plot_dir, "4gg_pick_aliens_ACC_subj.png"), gg_pick_aliens_ACC_subj, width = 15, height = 15)
  ggsave(file.path(plot_dir, "4gg_pick_aliens_raw_ch.png"), gg_pick_aliens_raw_ch, width = 6, height = 3)
  ggsave(file.path(plot_dir, "4gg_pick_aliens_raw_unch.png"), gg_pick_aliens_raw_unch, width = 6, height = 3)
  ggsave(file.path(plot_dir, "4gg_pick_aliens_raw_diff.png"), gg_pick_aliens_raw_diff, width = 6, height = 3)
}
```
```{r Plot learned values and true objective values}
value_plot = ggplot(subset(all_values_perf, assess != "AlienSameTS"), aes(assess, av_reward, fill = selected)) +
  stat_summary(fun.data = "mean_cl_normal", geom = "bar", position = "dodge") +
  stat_summary(fun.data = "mean_cl_normal", geom = "pointrange", position = position_dodge(width = 0.9)) +
  labs(y = "Average reward / trial", x = "", fill = "") +
  coord_flip()
value_plot_phase = value_plot + facet_wrap(~ phase)
value_plot_subj = value_plot + facet_wrap(phase ~ paste("Subj", subjID))

alien_plot = value_plot + aes(x = TS, fill = sad_alien) + labs(fill = "Alien") + facet_wrap(~ phase)
alien_plot$data = alien_TS_values
alien_plot2 = alien_plot + facet_wrap(~ paste("Subj", subjID))

# True objective values
aliens = sort(unique(as.numeric(as.character(all_files$sad_alien[!is.na(all_files$sad_alien)]))))
TSs = sort(unique(all_files$TS[all_files$phase == "1InitialLearning" & !is.na(all_files$TS)]))
alien_TS_obj = expand.grid(sad_alien = aliens,
                           TS = TSs)
alien_TS_obj$av_reward = c(6, 4, 5, 10,
                           2, 8, 7, 3,
                           7, 3, 3, 2)
alien_TS_obj$selected = factor(alien_TS_obj$sad_alien)
alien_TS_obj$assess = factor(alien_TS_obj$TS)

true_values = value_plot + labs(title = "True underlying TS", fill = "Alien")
true_values$data = alien_TS_obj

if (gg_save) {
  ggsave(file.path(plot_dir, "0value_plot.png"), value_plot_phase, width = 9, height = 3)
  ggsave(file.path(plot_dir, "0alien_plot.png"), alien_plot, width = 9, height = 3)
  ggsave(file.path(plot_dir, "0alien_plot2.png"), alien_plot2, width = 15, height = 15)
  ggsave(file.path(plot_dir, "0true_values.png"), true_values, width = 3, height = 3)
  ggsave(file.path(plot_dir, "0value_plot_subj.png"), value_plot_subj, width = 15, height = 15)
}
```
```{r Prepare learning data for plotting (feed_aliens)}
# Plotting data: feed_aliens
feed_aliens = subset(all_files, trial_type == "feed-aliens")

## Add objective values (rewards based on underlying TS)
feed_aliens = merge(feed_aliens, all.x = T,
                    subset(alien_TS_obj, select = c("sad_alien", "TS", "av_reward")),
                    by = c("sad_alien", "TS"))

## Add "subjective" values (experienced average rewards during refresher 1)
feed_aliens = merge(feed_aliens, all.x = T,
                    subset(alien_TS_values, phase == "1InitialLearning", select = c("subjID", "sad_alien", "TS", "av_reward")),
                    by = c("subjID", "sad_alien", "TS"),
                    suffixes = c("", "_subj"))
## Add alien_trial_sum: only goes from 0 to 10, not to 40; repetitions of the same TS in the same phase will be averaged together
feed_aliens$alien_trial_sum = feed_aliens$alien_trial
while (any(feed_aliens$alien_trial_sum[feed_aliens$phase == "1InitialLearning"] > n_trials_initial)) {
  feed_aliens$alien_trial_sum[feed_aliens$phase == "1InitialLearning" & feed_aliens$alien_trial_sum > n_trials_initial] = feed_aliens$alien_trial_sum[feed_aliens$phase == "1InitialLearning" & feed_aliens$alien_trial_sum > n_trials_initial] - n_trials_initial
}
while (any(feed_aliens$alien_trial_sum[feed_aliens$phase == "2CloudySeason"] > n_trials_cloudy)) {
  feed_aliens$alien_trial_sum[feed_aliens$phase == "2CloudySeason" & feed_aliens$alien_trial_sum > n_trials_cloudy] = feed_aliens$alien_trial_sum[feed_aliens$phase == "2CloudySeason" & feed_aliens$alien_trial_sum > n_trials_cloudy] - n_trials_cloudy
}
```
```{r Prepare learning data for regressions (regr_dat)}
# Regression data: regr_dat
## Bring in the right order for regression: each line must be the predictor of the immediate next line!
feed_aliens = feed_aliens[order(feed_aliens$subjID, feed_aliens$phase, feed_aliens$sad_alien, feed_aliens$TS, feed_aliens$alien_trial),]
regr_dat = subset(feed_aliens, select = c("subjID", "phase", "sad_alien", "TS", "reward", "av_reward", "trial", "alien_trial_sum", "alien_trial", "ACC"))

ACC_1back_self = c(NA, regr_dat$ACC[1:length(regr_dat$ACC)-1])
ACC_1back_self[regr_dat$alien_trial_sum == 1] = NA
regr_dat$ACC_1back_self = ACC_1back_self

rew_1back_self = c(NA, regr_dat$reward[1:length(regr_dat$reward)-1])
rew_1back_self[regr_dat$alien_trial_sum == 1] = NA
regr_dat$rew_1back_self = rew_1back_self

others_regr_dat = data.frame()
for (alien in unique(regr_dat$sad_alien)) {
  alien_regr_dat = ddply(subset(regr_dat, sad_alien != alien),
                    .(subjID, phase, TS, alien_trial, alien_trial_sum), summarize,
                    ACC_others = mean(ACC, na.rm = T))
  alien_regr_dat$sad_alien = alien
  others_regr_dat = rbind(others_regr_dat, alien_regr_dat)
}
others_regr_dat = others_regr_dat[order(others_regr_dat$subjID, others_regr_dat$phase, others_regr_dat$sad_alien, others_regr_dat$TS, others_regr_dat$alien_trial),]
ACC_1back_others = c(NA, others_regr_dat$ACC_others[1:length(others_regr_dat$ACC_others)-1])
ACC_1back_others[others_regr_dat$alien_trial_sum == 1] = NA
others_regr_dat$ACC_1back_others = ACC_1back_others

regr_dat = merge(others_regr_dat, regr_dat,  # sanity check: cloudy regr_dat should have 12000 rows: 50 subj * 20 alien_trials * 3 TS * 4 sad_aliens
                 by = c("subjID", "phase", "TS", "alien_trial", "alien_trial_sum", "sad_alien"))
regr_dat$TS = factor(regr_dat$TS)
regr_dat$sad_alien = factor(regr_dat$sad_alien)
```
```{r Plot first cloudy trials: How well do participants infer TS}
for (phas in c("1InitialLearning", "2CloudySeason")) {
  
  dat = subset(regr_dat, phase == phas & alien_trial_sum == 1)
  dat = dat[order(dat$subjID, dat$TS, dat$alien_trial, dat$trial),]
  for (n in 1:n_aliens) {
    col = paste("back", n, sep = "")
    dat[,col] = c(rep(NA, n), dat$ACC[1:(length(dat$ACC)-n)])
    dat[dat$trial <= n, col] = NA
  }
  dat$cum_ACC = rowSums(dat[,c("ACC", paste("back", 1:n_aliens, sep = ""))], na.rm = T)
  dat$cum_ACC_1back = c(NA, dat$cum_ACC[1:(length(dat$cum_ACC)-1)])
  dat$cum_ACC_1back[dat$trial == 1] = NA
  dat[,paste("back", 1:n_aliens, sep = "")] = NULL
  
  dat = subset(dat, !is.na(cum_ACC_1back))
  
  # dat = subset(feed_aliens, phase == phas & alien_trial_sum < n_aliens+1)
  # dat = subset(feed_aliens, phase == phas & trial %in% seq(2, 4), select = c("subjID", "sad_alien", "TS", "trial_index", "ACC", "alien_trial_sum", "trial", "av_reward"))
  # dat$n_evidence = dat$trial - 1
  dat$value = round(dat$av_reward / 3) * 3
  dat$evidence = dat$cum_ACC_1back
  dat$evidence[dat$evidence >= 1] = "1+"
  # dat[order(dat$subjID, dat$trial_index),]
  
  gg_value_guess = ggplot(dat, aes(evidence, 100 * ACC)) +  # , color = cum_ACC_1back, group = cum_ACC_1back
    stat_summary(fun.data = mean_se, geom = "bar") +
    stat_summary(fun.data = mean_se, aes(color = value, group = value), geom = "pointrange") +
    stat_summary(fun.data = mean_se, aes(color = value, group = value), geom = "line") +
    geom_hline(yintercept = 100/3, linetype = "dotted") +
    coord_cartesian(ylim = c(0, 100)) +
    labs(x = "# of previous correct trials", y = "% correct", color = "Value")
  
  if (gg_save) {
    ggsave(paste(plot_dir, "/2gg_value_guess_", phas, ".png", sep = ""), gg_value_guess, width = 3, height = 3)
  }
}
```
```{r Plot overall learning}
# Plot learning curves (and RTs) overall
overall_learning_curves = ggplot(feed_aliens, aes(trial_index, 100 * ACC, color = phase)) +
  stat_summary(fun.data = mean_se, geom = "pointrange") +
  geom_hline(yintercept = 100/3, linetype = "dotted") +
  labs(x = "Trial", y = "% correct")
overall_learning_curves_subj = overall_learning_curves + facet_wrap(~ subjID)
overall_RTs = overall_learning_curves + aes(trial_index, rt, color = phase) + labs(x = "Trial", y = "Response time (msec)")

if (gg_save) {
  ggsave(file.path(plot_dir, "1overall_learning_curves.png"), overall_learning_curves, width = 25, height = 3)
  ggsave(file.path(plot_dir, "1overall_learning_curves_subj.png"), overall_learning_curves_subj, width = 25, height = 25)
  ggsave(file.path(plot_dir, "1overall_RTs.png"), overall_RTs, width = 25, height = 3)
}
```
```{r Plot learning phase & cloudy season: Learning depends on reward size / value}
for (phas in c("1InitialLearning", "2CloudySeason")) {
  
  dat = subset(feed_aliens, phase == phas)
  dat$value = round(dat$av_reward / 2) * 2
  
  learning_curves_value = ggplot(dat, aes(alien_trial, 100 * ACC, color = value, group = value)) +
    stat_summary(fun.data = mean_se, geom = "pointrange") +
    geom_hline(yintercept = 100/3, linetype = "dotted") +
    coord_cartesian(y = c(0, 100)) +
    labs(x = "Trial", y = "% correct", color = "Value")
  learning_curves_valuep = learning_curves_value +
    aes(alien_trial_sum, 100 * ACC) +
    stat_summary(fun.data = mean_se, geom = "line") +
    labs(x = "Trial", y = "% correct", color = "Value")
  
  learning_curves_TS = learning_curves_value + aes(group = 1) + facet_grid(~ TS)
  learning_curves_TS_aliens = learning_curves_value + facet_grid(sad_alien ~ TS)
  
  learning_value_RTs = learning_curves_TS_aliens + aes(trial_index, rt) + coord_cartesian(ylim = c(0, 2000))
  
  learning_curves_wide = ggplot(dat, aes(alien_trial_sum, 100 * ACC, color = TS, shape = sad_alien)) +
    stat_summary(fun.data = mean_se, geom = "pointrange") +
    stat_summary(fun.data = mean_se, geom = "line") +
    labs(x = "Trial", y = "% correct") +
    coord_cartesian(y = c(0, 100)) +
    facet_grid(~ paste("Value", av_reward))

  if (gg_save) {
    ggsave(paste(plot_dir, "/2learning_curves_value_", phas, ".png", sep = ""), learning_curves_valuep, width = 3, height = 3)
    ggsave(paste(plot_dir, "/2learning_curves_TS_", phas, ".png", sep = ""), learning_curves_TS, width = 7, height = 3)
    ggsave(paste(plot_dir, "/2learning_curves_TS_aliens_", phas, ".png", sep = ""), learning_curves_TS_aliens, width = 10, height = 10)
    ggsave(paste(plot_dir, "/2learning_value_RTs_", phas, ".png", sep = ""), learning_value_RTs, width = 10, height = 10)
    ggsave(paste(plot_dir, "/2learning_curves_wide_", phas, ".png", sep = ""), learning_curves_wide, width = 15, height = 3)
  }
}
```
```{r Run regressions: Participants infer complete TS rather than individual mappings}
regression_plot = alien_plot + aes(TS, 100 * ACC, fill = sad_alien) + labs(y = "% correct", fill = "Alien")
regression_plot$data = subset(regr_dat, phase == "2CloudySeason")
ggsave(file.path(plot_dir, "3regression_plot.png"), regression_plot, width = 3, height = 3)

if (run_regression) {
  for (phase in c("1InitialLearning", "2CloudySeasons")) {
    
    oneback_self_others_form = "ACC ~ ACC_1back_self * ACC_1back_others + (ACC_1back_self * ACC_1back_others | subjID)"
    rew_1back_form = "ACC ~ rew_1back_self + (rew_1back_self | subjID)"
    all3_form = "ACC ~ ACC_1back_self * ACC_1back_others * rew_1back_self + (ACC_1back_self * ACC_1back_others * rew_1back_self | subjID)"
  
    glmer_mod_1back_self_others = glmer(as.formula(oneback_self_others_form),
                      family = binomial,
                      data = subset(regr_dat, phase == phase),
                      na.action = na.omit,
                      control = glmerControl(optimizer = 'bobyqa', optCtrl = list(maxfun = 1e6)))
    write.csv(as.data.frame(summary(glmer_mod_1back_self_others)$coef), paste(plot_dir, "/glmer_oneback_self_others_summary_", phase, ".csv", sep = ""))
    write.csv(as.data.frame(anova(glmer_mod_1back_self_others, type = 3)), paste(plot_dir, "/glmer_oneback_self_others_aov_", phase, ".csv", sep = ""))
    
    glmer_mod_rew_1back = update(glmer_mod_1back_self_others, formula = as.formula(rew_1back_form))
    write.csv(as.data.frame(summary(glmer_mod_rew_1back)$coef), paste(plot_dir, "/glmer_rew_1back_summary_", phase, ".csv", sep = ""))
    write.csv(as.data.frame(anova(glmer_mod_rew_1back, type = 3)), paste(plot_dir, "/glmer_rew_1back_aov_", phase, ".csv", sep = ""))
  
    glmer_mod_all3 = update(glmer_mod_1back_self_others, formula = as.formula(all3_form))
    write.csv(as.data.frame(summary(glmer_mod_all3)$coef), paste(plot_dir, "/glmer_all3_summary_", phase, ".csv", sep = ""))
    write.csv(as.data.frame(anova(glmer_mod_all3, type = 3)), paste(plot_dir, "/glmer_all3_aov_", phase, ".csv", sep = ""))
  }
}
```
```{r Rainbow season}
# Get data that shows choices that correspond to the 3 TS
correct_values = ddply(subset(all_files, ACC == 1 & season %in% c("cold", "hot", "rainy")),
                      .(subjID, TS, sad_alien), summarize,
                      av_reward = mean(reward, na.rm = T),
                      item_chosen = item_chosen[1])
correct_values  # agrees with the TS!

# Get subjects' choices in the rainbow season
rainbow_aliens = ddply(subset(feed_aliens, phase == "5RainbowSeason", item_chosen != "NaN"),
                       .(subjID, sad_alien, TS, item_chosen),
                       summarize,
                       av_reward = sum(!is.na(item_chosen)))  # add column that indicates in how many trials subject chose each item for each alien
rainbow_aliens = subset(rainbow_aliens, item_chosen != "NaN")
rainbow_aliens

# Create data of randomly acting subjects' choices (as a baselien to see if actual participants are closer to the TS, and to which ones)
# TD

# Categorize participants' strategies: count of choices "within" each TS divided by total number of choices
rainbow_aliens$TS0 = rainbow_aliens$TS1 = rainbow_aliens$TS2 = F
rainbow_aliens$TS0[rainbow_aliens$TS == 0 & item_chosen %in% c(...)] = T
rainbow_aliens$TS0[rainbow_aliens$TS == 1 & item_chosen %in% c(...)] = T
rainbow_aliens$TS0[rainbow_aliens$TS == 2 & item_chosen %in% c(...)] = T

ddply(rainbow_aliens, .(subjID), summarize,
      TS0sim = sum(TS0),
      TS1sim = sum(TS1),
      tS2sim = sum(TS2))
```

```{r}

for (subj in unique(rainbow_aliens$subjID)) {
  
  subj_dat = ddply(subset(rainbow_aliens, subjID == subj), 
                   .(), summarize)
  
  
}
# for each individual subject's choices
# for the choices of the whole group

rainbow_aliens$strategy = "TSX"
for (subj in unique(rainbow_aliens$subjID)) {
  
  subj_dat = subset(rainbow_aliens, subjID == subj)
  
  var1_criterion = sum(subj_dat$av_reward >= 2) >= 8  # if participant chooses at least 8 different alien-item combinations (out of 16)
  if (var1_criterion) {
    rainbow_aliens$strategy[rainbow_aliens$subjID == subj] = "Variance 1"
  }
  
  for (item in unique(subj_dat$item_chosen)) {
    n_item_chosen = sum(subset(subj_dat, item_chosen == item)$av_reward)
    if (n_item_chosen >= 16) {  # if participant chooses the same item at least 8 times, irrespective of alien (out of 16)
      rainbow_aliens$strategy[rainbow_aliens$subjID == subj] = "Variance 0"
    }
  }
}

# Combine OPTIMAL CHOICES (not necessarily subject's choices) with subject's choices in the rainbow season
comb_dat = merge(correct_values,
                 rainbow_aliens,
                 by = c("subjID", "sad_alien", "strategy", "TS", "item_chosen", "av_reward"), all = T)
comb_dat

# Plot OPTIMAL CHOICES in every season together with subject's choices in the rainbow season
comb_dat_sum = ddply(subset(comb_dat, strategy == "TSX"),
                     .(sad_alien, item_chosen, TS), summarize,
                     av_reward = sum(av_reward, na.rm = T))
comb_dat_sum$av_reward[comb_dat_sum$TS == "rainbow"] = 7 * comb_dat_sum$av_reward[comb_dat_sum$TS == "rainbow"] - 15  # to make differences in size more evident

comb_dat$TSx = comb_dat$TS == "rainbow"
comb_dat_sum2 = ddply(subset(comb_dat, strategy == "TSX"),
                     .(sad_alien, item_chosen, TSx), summarize,
                     av_reward = mean(av_reward, na.rm = T))

comb_dat_sum2_wide = reshape(comb_dat_sum2, timevar = "TSx", idvar = c("sad_alien", "item_chosen"), direction = "wide")
comb_dat_sum2_wide$av_reward.TRUE = (comb_dat_sum2_wide$av_reward.TRUE - mean(comb_dat_sum2_wide$av_reward.TRUE)) / sd(comb_dat_sum2_wide$av_reward.TRUE)
comb_dat_sum2_wide$av_reward.FALSE = (comb_dat_sum2_wide$av_reward.FALSE - mean(comb_dat_sum2_wide$av_reward.FALSE, na.rm = T)) / sd(comb_dat_sum2_wide$av_reward.FALSE, na.rm = T)
comb_dat_sum2_wide$diff = comb_dat_sum2_wide$av_reward.TRUE - comb_dat_sum2_wide$av_reward.FALSE

diff_between_TS_and_comp = ggplot(comb_dat_sum2_wide, aes(sad_alien, item_chosen, size = diff)) +
  geom_point() +
  theme(legend.position = "none") +
  labs(x = "Alien ID", y = "", color = "")

comb_dat_sum2$av_reward[comb_dat_sum2$TSx == T] = 15 * comb_dat_sum2$av_reward[comb_dat_sum2$TSx == T] - 20  # to make differences in size more evident - SHOULD NORMALIZE BOTH INSTEAD
gg_rainbow_choice = ggplot(comb_dat_sum, aes(sad_alien, item_chosen, color = TS, size = av_reward)) +
  geom_point() +
  theme(legend.position = "none") +
  labs(x = "Alien ID", y = "", color = "") +
  facet_grid( ~ paste("TS", TS))

gg_rainbow_choice2 = gg_rainbow_choice + aes(color = TSx) + facet_grid( ~ TSx)
gg_rainbow_choice2$data = comb_dat_sum2

gg_rainbow_choice_subj = ggplot(subset(comb_dat, TS == "rainbow"), aes(sad_alien, item_chosen, color = TS, size = av_reward)) +
  geom_point() +
  theme(legend.position = "none") +
  facet_wrap(~ paste("Subj", subjID))


if (gg_save) {
  ggsave(file.path(plot_dir, "5gg_rainbow_choice.png"), gg_rainbow_choice, width = 5, height = 3)
  ggsave(file.path(plot_dir, "5gg_rainbow_choice2.png"), gg_rainbow_choice2, width = 5, height = 3)
  ggsave(file.path(plot_dir, "5diff_between_TS_and_comp.png"), diff_between_TS_and_comp, width = 3, height = 3)
  ggsave(file.path(plot_dir, "5gg_rainbow_choice_subj.png"), gg_rainbow_choice_subj, width = 15, height = 15)
}
```
```{r Start button}
```